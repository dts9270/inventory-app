<!doctype html>
<html lang="mr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡§∏‡§æ‡§Æ‡§æ‡§® ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‚Äî Full Features</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body{font-family:Inter,system-ui;background:#fff7ed}
  .card{border-radius:12px;background:#fff;box-shadow:0 8px 24px rgba(0,0,0,0.06)}
  .muted{color:#6b7280}
  .btn{padding:.6rem .9rem;border-radius:10px;font-weight:600}
  @media (max-width:420px){ .max-w {padding:.6rem} }
</style>
</head>
<body class="p-4">

<div class="max-w-lg mx-auto max-w p-4">
  <header class="text-center mb-4">
    <h1 class="text-2xl font-bold text-amber-700">üì¶ ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® (Pro)</h1>
    <p class="muted text-sm">Full features ‚Äî Ledger, Charts, PDF/Excel, WhatsApp share, PWA</p>
  </header>

  <!-- TABS -->
  <div class="flex gap-2 mb-4">
    <button id="tabIn" class="flex-1 btn bg-amber-600 text-white">IN</button>
    <button id="tabOut" class="flex-1 btn bg-white border text-amber-700">OUT</button>
    <button id="tabRep" class="flex-1 btn bg-white border text-amber-700">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</button>
    <button id="tabLedger" class="flex-1 btn bg-white border text-amber-700">‡§≤‡•á‡§ú‡§∞</button>
  </div>

  <!-- IN -->
  <section id="panelIn" class="card p-4 mb-4">
    <h2 class="font-bold text-lg text-amber-700 mb-3">IN ‚Äî ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ò‡•á‡§§‡§≤‡•á</h2>
    <div class="space-y-2">
      <input id="inDate" type="date" class="w-full p-2 border rounded" />
      <input id="inFrom" placeholder="‡§ï‡•ã‡§£‡§æ‡§ï‡§°‡•Ç‡§®" class="w-full p-2 border rounded" />
      <div class="grid grid-cols-2 gap-2">
        <input id="inTotal" type="number" placeholder="‡§è‡§ï‡•Ç‡§£ (‚Çπ)" class="p-2 border rounded" />
        <input id="inPaid" type="number" placeholder="‡§≠‡§∞‡§≤‡•á (‚Çπ)" class="p-2 border rounded" />
      </div>
      <select id="inPayType" class="w-full p-2 border rounded">
        <option>Cash</option><option>Online</option><option>Baki</option>
      </select>
      <input id="inFile" type="file" accept="image/*,application/pdf" class="w-full" />
      <div class="flex gap-2">
        <button id="btnIn" class="flex-1 bg-amber-600 text-white btn">IN ‡§ú‡§§‡§® ‡§ï‡§∞‡§æ</button>
        <button id="btnInClear" class="flex-1 bg-gray-200 btn">‡§∞‡§¶‡•ç‡§¶</button>
      </div>
    </div>

    <h3 class="mt-4 font-semibold">Recent IN</h3>
    <div id="recentIn" class="mt-2 text-sm"></div>
  </section>

  <!-- OUT -->
  <section id="panelOut" class="card p-4 mb-4 hidden">
    <h2 class="font-bold text-lg text-blue-700 mb-3">OUT ‚Äî ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§¶‡§ø‡§≤‡•á</h2>
    <div class="space-y-2">
      <input id="outDate" type="date" class="w-full p-2 border rounded" />
      <input id="outTo" placeholder="‡§ï‡•ã‡§£‡§æ‡§≤‡§æ" class="w-full p-2 border rounded" />
      <div class="grid grid-cols-2 gap-2">
        <input id="outTotal" type="number" placeholder="‡§è‡§ï‡•Ç‡§£ (‚Çπ)" class="p-2 border rounded" />
        <input id="outPaid" type="number" placeholder="‡§≠‡§∞‡§≤‡•á (‚Çπ)" class="p-2 border rounded" />
      </div>
      <select id="outPayType" class="w-full p-2 border rounded">
        <option>Cash</option><option>Online</option><option>Baki</option>
      </select>
      <input id="outFile" type="file" accept="image/*,application/pdf" class="w-full" />
      <div class="flex gap-2">
        <button id="btnOut" class="flex-1 bg-blue-600 text-white btn">OUT ‡§ú‡§§‡§® ‡§ï‡§∞‡§æ</button>
        <button id="btnOutClear" class="flex-1 bg-gray-200 btn">‡§∞‡§¶‡•ç‡§¶</button>
      </div>
    </div>

    <h3 class="mt-4 font-semibold">Recent OUT</h3>
    <div id="recentOut" class="mt-2 text-sm"></div>
  </section>

  <!-- REPORT -->
  <section id="panelRep" class="card p-4 mb-4 hidden">
    <h2 class="font-bold text-lg mb-3">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</h2>

    <div class="grid grid-cols-2 gap-2 mb-2">
      <input id="filterFrom" type="date" class="p-2 border rounded" />
      <input id="filterTo" type="date" class="p-2 border rounded" />
    </div>
    <input id="filterName" placeholder="‡§®‡§æ‡§µ ‡§∂‡•ã‡§ß‡§æ" class="w-full p-2 border rounded mb-2" />

    <div id="statsBox" class="p-2 border rounded mb-3 text-sm"></div>

    <div class="flex gap-2 mb-2">
      <button id="exportPdfBtn" class="flex-1 bg-gray-800 text-white p-2 rounded">PDF</button>
      <button id="exportXlsxBtn" class="flex-1 bg-green-600 text-white p-2 rounded">Excel</button>
    </div>

    <div class="flex gap-2 mb-2">
      <button id="backupBtn" class="flex-1 bg-purple-600 text-white p-2 rounded">üì• Backup</button>
      <button id="uploadBackupBtn" class="flex-1 bg-indigo-600 text-white p-2 rounded">üîº Upload Backup to Storage</button>
      <button id="restoreBtn" class="flex-1 bg-orange-600 text-white p-2 rounded">üì§ Restore</button>
      <input id="restoreFileInput" type="file" accept="application/json" class="hidden" />
    </div>

    <div class="mt-2 mb-2">
      <canvas id="chartCanvas" height="160"></canvas>
    </div>

    <button id="dailyPdfBtn" class="w-full bg-red-600 text-white p-2 rounded">üìÖ ‡§Ü‡§ú‡§ö‡§æ Daily PDF</button>
    <div class="mt-2 text-xs muted">WhatsApp share ‡§¨‡§ü‡§® ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï entry ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Æ‡§ø‡§≥‡•á‡§≤.</div>
  </section>

  <!-- LEDGER -->
  <section id="panelLedger" class="card p-4 mb-4 hidden">
    <h2 class="font-bold text-lg mb-3">‡§≤‡•á‡§ú‡§∞ (Customer / Supplier)</h2>
    <input id="ledgerSearch" placeholder="‡§®‡§æ‡§µ ‡§∂‡•ã‡§ß‡§æ..." class="w-full p-2 border rounded mb-2" />
    <div id="ledgerList" class="text-sm"></div>
    <div id="ledgerDetail" class="mt-3 text-sm"></div>
  </section>

  <footer class="text-center text-sm text-gray-500 mt-4">¬© Inventory ‚Ä¢ Admin: 7020970727</footer>
</div>

<script>
/* ---------- Firebase config (use your config) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyA3PdBavWlcE3w3QjgyOykv2jkAuFcUWbY",
  authDomain: "product-buy-sell.firebaseapp.com",
  projectId: "product-buy-sell",
  storageBucket: "product-buy-sell.appspot.com",
  messagingSenderId: "815213852798",
  appId: "1:815213852798:web:d347aec03aa3a46ba3802f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

/* ---------- UI refs ---------- */
const panels = { in: document.getElementById('panelIn'), out: document.getElementById('panelOut'), rep: document.getElementById('panelRep'), ledger: document.getElementById('panelLedger') };
const tabs = { in: document.getElementById('tabIn'), out: document.getElementById('tabOut'), rep: document.getElementById('tabRep'), ledger: document.getElementById('tabLedger') };
const inDate = document.getElementById('inDate'), inFrom = document.getElementById('inFrom'), inTotal = document.getElementById('inTotal'), inPaid = document.getElementById('inPaid'), inPayType = document.getElementById('inPayType'), inFile = document.getElementById('inFile'), btnIn = document.getElementById('btnIn'), btnInClear = document.getElementById('btnInClear'), recentIn = document.getElementById('recentIn');
const outDate = document.getElementById('outDate'), outTo = document.getElementById('outTo'), outTotal = document.getElementById('outTotal'), outPaid = document.getElementById('outPaid'), outPayType = document.getElementById('outPayType'), outFile = document.getElementById('outFile'), btnOut = document.getElementById('btnOut'), btnOutClear = document.getElementById('btnOutClear'), recentOut = document.getElementById('recentOut');
const filterFrom = document.getElementById('filterFrom'), filterTo = document.getElementById('filterTo'), filterName = document.getElementById('filterName'), statsBox = document.getElementById('statsBox');
const exportPdfBtn = document.getElementById('exportPdfBtn'), exportXlsxBtn = document.getElementById('exportXlsxBtn'), backupBtn = document.getElementById('backupBtn'), restoreBtn = document.getElementById('restoreBtn'), restoreFileInput = document.getElementById('restoreFileInput'), uploadBackupBtn = document.getElementById('uploadBackupBtn'), dailyPdfBtn = document.getElementById('dailyPdfBtn');
const ledgerSearch = document.getElementById('ledgerSearch'), ledgerList = document.getElementById('ledgerList'), ledgerDetail = document.getElementById('ledgerDetail');
const chartCanvas = document.getElementById('chartCanvas').getContext('2d');

/* ---------- helpers ---------- */
function showPanel(name){
  Object.values(panels).forEach(p => p.classList.add('hidden'));
  panels[name].classList.remove('hidden');
  Object.values(tabs).forEach(t => t.classList.remove('bg-amber-600','text-white','bg-blue-600','bg-green-600'));
  if(name==='in'){ tabs.in.classList.add('bg-amber-600','text-white'); }
  if(name==='out'){ tabs.out.classList.add('bg-blue-600','text-white'); }
  if(name==='rep'){ tabs.rep.classList.add('bg-green-600','text-white'); loadReports(); }
  if(name==='ledger'){ tabs.ledger.classList.add('bg-amber-600','text-white'); loadLedger(); }
}
tabs.in.onclick = ()=> showPanel('in');
tabs.out.onclick = ()=> showPanel('out');
tabs.rep.onclick = ()=> showPanel('rep');
tabs.ledger.onclick = ()=> showPanel('ledger');
showPanel('in');

function toast(m){ alert(m); }
function fmt(n){ return Number(n||0).toFixed(2); }
function uid(){ return Math.random().toString(36).slice(2,9); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function debounce(fn,t=300){ let id; return (...a)=>{ clearTimeout(id); id=setTimeout(()=>fn(...a),t); }; }

/* ---------- file upload ---------- */
async function uploadFile(file, folder){
  if(!file) return null;
  const path = `${folder}/${Date.now()}_${uid()}_${file.name.replaceAll(' ','_')}`;
  const ref = storage.ref().child(path);
  await ref.put(file);
  return await ref.getDownloadURL();
}

/* ---------- delete file by url ---------- */
async function deleteFileByUrl(url){
  if(!url) return;
  try{
    const ref = storage.refFromURL(url);
    await ref.delete();
  }catch(e){ console.warn('deleteFileErr', e); }
}

/* ---------- edit state ---------- */
let editInId = null, editOutId = null;

/* ---------- IN save/update ---------- */
btnIn.addEventListener('click', async ()=>{
  const date = inDate.value || new Date().toISOString().slice(0,10);
  const from = (inFrom.value||'').trim();
  const total = Number(inTotal.value)||0;
  const paid = Number(inPaid.value)||0;
  const payType = inPayType.value || 'Cash';
  const file = inFile.files[0];

  if(!from) return toast('‡§ï‡•É‡§™‡§Ø‡§æ "‡§ï‡•ã‡§£‡§æ‡§ï‡§°‡•Ç‡§®" ‡§≠‡§∞‡§æ');

  const payload = { date, from, total, paid, balance: total - paid, payType, createdAt: Date.now() };

  try{
    if(editInId){
      const ref = db.collection('in_entries').doc(editInId);
      const doc = await ref.get();
      const old = doc.data();
      if(file){
        const newUrl = await uploadFile(file,'in');
        payload.fileURL = newUrl;
        if(old && old.fileURL) await deleteFileByUrl(old.fileURL);
      } else if(old && old.fileURL){
        payload.fileURL = old.fileURL;
      }
      await ref.update(payload);
      toast('IN ‡§Ö‡§™‡§°‡•á‡§ü ‡§ù‡§æ‡§≤‡•á');
      editInId = null; btnIn.textContent = 'IN ‡§ú‡§§‡§® ‡§ï‡§∞‡§æ';
    } else {
      if(file) payload.fileURL = await uploadFile(file,'in');
      await db.collection('in_entries').add(payload);
      toast('IN ‡§ú‡§§‡§® ‡§ù‡§æ‡§≤‡•á');
    }
    inFormReset(); loadRecent(); loadReports();
  }catch(e){ console.error(e); toast('IN error: '+(e.message||e)); }
});

/* ---------- OUT save/update ---------- */
btnOut.addEventListener('click', async ()=>{
  const date = outDate.value || new Date().toISOString().slice(0,10);
  const to = (outTo.value||'').trim();
  const total = Number(outTotal.value)||0;
  const paid = Number(outPaid.value)||0;
  const payType = outPayType.value || 'Cash';
  const file = outFile.files[0];

  if(!to) return toast('‡§ï‡•É‡§™‡§Ø‡§æ "‡§ï‡•ã‡§£‡§æ‡§≤‡§æ" ‡§≠‡§∞‡§æ');

  const payload = { date, to, total, paid, balance: total - paid, payType, createdAt: Date.now() };

  try{
    if(editOutId){
      const ref = db.collection('out_entries').doc(editOutId);
      const doc = await ref.get();
      const old = doc.data();
      if(file){
        const newUrl = await uploadFile(file,'out');
        payload.fileURL = newUrl;
        if(old && old.fileURL) await deleteFileByUrl(old.fileURL);
      } else if(old && old.fileURL){
        payload.fileURL = old.fileURL;
      }
      await ref.update(payload);
      toast('OUT ‡§Ö‡§™‡§°‡•á‡§ü ‡§ù‡§æ‡§≤‡•á');
      editOutId = null; btnOut.textContent = 'OUT ‡§ú‡§§‡§® ‡§ï‡§∞‡§æ';
    } else {
      if(file) payload.fileURL = await uploadFile(file,'out');
      await db.collection('out_entries').add(payload);
      toast('OUT ‡§ú‡§§‡§® ‡§ù‡§æ‡§≤‡•á');
    }
    outFormReset(); loadRecent(); loadReports();
  }catch(e){ console.error(e); toast('OUT error: '+(e.message||e)); }
});

/* ---------- reset forms ---------- */
function inFormReset(){ inDate.value=''; inFrom.value=''; inTotal.value=''; inPaid.value=''; inPayType.value='Cash'; inFile.value=null; }
function outFormReset(){ outDate.value=''; outTo.value=''; outTotal.value=''; outPaid.value=''; outPayType.value='Cash'; outFile.value=null; }

/* ---------- load recent with edit/delete and whatsapp share ---------- */
async function loadRecent(){
  recentIn.innerHTML = '<div class="text-sm text-gray-500">‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á‚Ä¶</div>';
  recentOut.innerHTML = '<div class="text-sm text-gray-500">‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á‚Ä¶</div>';
  try{
    const inSnap = await db.collection('in_entries').orderBy('createdAt','desc').limit(12).get();
    let htmlIn = '';
    inSnap.forEach(d=>{
      const id = d.id; const v = d.data();
      htmlIn += `<div class="flex justify-between items-start p-2 border rounded mb-2">
        <div>
          <div class="font-semibold">‚Çπ${fmt(v.total)} ‚Ä¢ ${escapeHtml(v.from)}</div>
          <div class="text-xs muted">${v.date || ''} ‚Ä¢ Paid ‚Çπ${fmt(v.paid)} ‚Ä¢ Bal ‚Çπ${fmt(v.balance)}</div>
        </div>
        <div class="flex flex-col gap-2 items-end">
          <button class="text-xs text-blue-600" onclick="editIn('${id}')">Edit</button>
          <button class="text-xs text-red-600" onclick="deleteIn('${id}')">Delete</button>
          ${v.fileURL?`<a class="text-xs text-amber-600" href="${v.fileURL}" target="_blank">View</a>`:''}
          <button class="text-xs text-green-700" onclick="shareWhatsApp('IN', '${id}')">WhatsApp</button>
        </div>
      </div>`;
    });
    recentIn.innerHTML = htmlIn || '<div class="text-sm text-gray-500">‡§ï‡•ã‡§£‡§§‡•Ä‡§π‡•Ä IN ‡§®‡•ã‡§Ç‡§¶ ‡§®‡§æ‡§π‡•Ä.</div>';

    const outSnap = await db.collection('out_entries').orderBy('createdAt','desc').limit(12).get();
    let htmlOut = '';
    outSnap.forEach(d=>{
      const id = d.id; const v = d.data();
      htmlOut += `<div class="flex justify-between items-start p-2 border rounded mb-2">
        <div>
          <div class="font-semibold">‚Çπ${fmt(v.total)} ‚Ä¢ ${escapeHtml(v.to)}</div>
          <div class="text-xs muted">${v.date || ''} ‚Ä¢ Paid ‚Çπ${fmt(v.paid)} ‚Ä¢ Bal ‚Çπ${fmt(v.balance)}</div>
        </div>
        <div class="flex flex-col gap-2 items-end">
          <button class="text-xs text-blue-600" onclick="editOut('${id}')">Edit</button>
          <button class="text-xs text-red-600" onclick="deleteOut('${id}')">Delete</button>
          ${v.fileURL?`<a class="text-xs text-amber-600" href="${v.fileURL}" target="_blank">View</a>`:''}
          <button class="text-xs text-green-700" onclick="shareWhatsApp('OUT', '${id}')">WhatsApp</button>
        </div>
      </div>`;
    });
    recentOut.innerHTML = htmlOut || '<div class="text-sm text-gray-500">‡§ï‡•ã‡§£‡§§‡•Ä‡§π‡•Ä OUT ‡§®‡•ã‡§Ç‡§¶ ‡§®‡§æ‡§π‡•Ä.</div>';
  }catch(e){ console.error(e); recentIn.innerHTML = recentOut.innerHTML = '<div class="text-sm text-red-500">‡§≤‡•ã‡§° ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä</div>'; }
}
window.loadRecent = loadRecent;

/* ---------- edit/delete implementations ---------- */
window.editIn = async function(id){
  try{
    const doc = await db.collection('in_entries').doc(id).get();
    const v = doc.data();
    inDate.value = v.date || ''; inFrom.value = v.from || ''; inTotal.value = v.total||''; inPaid.value = v.paid||''; inPayType.value = v.payType||'Cash';
    editInId = id; btnIn.textContent = 'Update IN'; showPanel('in'); window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ console.error(e); toast('Edit ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä'); }
};
window.editOut = async function(id){
  try{
    const doc = await db.collection('out_entries').doc(id).get();
    const v = doc.data();
    outDate.value = v.date || ''; outTo.value = v.to || ''; outTotal.value = v.total||''; outPaid.value = v.paid||''; outPayType.value = v.payType||'Cash';
    editOutId = id; btnOut.textContent = 'Update OUT'; showPanel('out'); window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ console.error(e); toast('Edit ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä'); }
};

window.deleteIn = async function(id){
  if(!confirm('‡§π‡•Ä IN ‡§®‡•ã‡§Ç‡§¶ ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡•Ä ‡§Ü‡§π‡•á ‡§ï‡§æ?')) return;
  try{
    const doc = await db.collection('in_entries').doc(id).get(); const v = doc.data();
    if(v && v.fileURL) await deleteFileByUrl(v.fileURL);
    await db.collection('in_entries').doc(id).delete();
    toast('IN ‡§π‡§ü‡§µ‡§≤‡•Ä');
    loadRecent(); loadReports(); loadLedger();
  }catch(e){ console.error(e); toast('Delete error'); }
};
window.deleteOut = async function(id){
  if(!confirm('‡§π‡•Ä OUT ‡§®‡•ã‡§Ç‡§¶ ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡•Ä ‡§Ü‡§π‡•á ‡§ï‡§æ?')) return;
  try{
    const doc = await db.collection('out_entries').doc(id).get(); const v = doc.data();
    if(v && v.fileURL) await deleteFileByUrl(v.fileURL);
    await db.collection('out_entries').doc(id).delete();
    toast('OUT ‡§π‡§ü‡§µ‡§≤‡•Ä');
    loadRecent(); loadReports(); loadLedger();
  }catch(e){ console.error(e); toast('Delete error'); }
};

/* ---------- WhatsApp share ---------- */
async function shareWhatsApp(type, id){
  try{
    let doc;
    if(type==='IN') doc = await db.collection('in_entries').doc(id).get();
    else doc = await db.collection('out_entries').doc(id).get();
    const v = doc.data();
    if(!v) return toast('‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§≥‡§æ‡§≤‡§æ ‡§®‡§æ‡§π‡•Ä');
    const name = v.from || v.to || '';
    const text = `${type} Entry\nName: ${name}\nDate: ${v.date || ''}\nTotal: ‚Çπ${fmt(v.total)}\nPaid: ‚Çπ${fmt(v.paid)}\nBalance: ‚Çπ${fmt(v.balance)}\n${v.fileURL ? '‡§¨‡§ø‡§≤: ' + v.fileURL : ''}`;
    const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(url,'_blank');
  }catch(e){ console.error(e); toast('Share error'); }
}

/* ---------- Reports & Chart ---------- */
let chartInstance = null;
async function loadReports(){
  statsBox.innerHTML = '‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...';
  try{
    const name = (filterName.value||'').trim().toLowerCase();
    const from = filterFrom.value || null;
    const to = filterTo.value || null;

    const inSnap = await db.collection('in_entries').orderBy('date','desc').get();
    const outSnap = await db.collection('out_entries').orderBy('date','desc').get();
    let IN = inSnap.docs.map(d=>({id:d.id,...d.data()}));
    let OUT = outSnap.docs.map(d=>({id:d.id,...d.data()}));

    if(name){
      IN = IN.filter(i => (i.from||'').toLowerCase().includes(name));
      OUT = OUT.filter(o => (o.to||'').toLowerCase().includes(name));
    }
    if(from){ IN = IN.filter(i=> (i.date||'') >= from); OUT = OUT.filter(o=> (o.date||'') >= from); }
    if(to){ IN = IN.filter(i=> (i.date||'') <= to); OUT = OUT.filter(o=> (o.date||'') <= to); }

    window._reportIn = IN; window._reportOut = OUT;

    const sumIn = IN.reduce((a,b)=>a+Number(b.total||0),0);
    const sumInPaid = IN.reduce((a,b)=>a+Number(b.paid||0),0);
    const sumOut = OUT.reduce((a,b)=>a+Number(b.total||0),0);
    const sumOutPaid = OUT.reduce((a,b)=>a+Number(b.paid||0),0);

    statsBox.innerHTML = `<div><b>IN:</b> ‚Çπ${fmt(sumIn)} Paid: ‚Çπ${fmt(sumInPaid)} Bal: ‚Çπ${fmt(sumIn-sumInPaid)}</div>
      <div class="mt-2"><b>OUT:</b> ‚Çπ${fmt(sumOut)} Paid: ‚Çπ${fmt(sumOutPaid)} Bal: ‚Çπ${fmt(sumOut-sumOutPaid)}</div>`;

    // Chart: month-wise totals for last 6 months
    const months = {}; // yyyy-mm => {in:0,out:0}
    function addMonth(key, t, amt){ if(!months[key]) months[key]={in:0,out:0}; months[key][t]+=amt; }
    const pushMonth = (d, t, amt)=>{ const date = new Date(d); const k = date.getFullYear()+'-'+String(date.getMonth()+1).padStart(2,'0'); addMonth(k,t,amt); };
    IN.forEach(i=> pushMonth(i.date,'in', Number(i.total||0)));
    OUT.forEach(o=> pushMonth(o.date,'out', Number(o.total||0)));
    const keys = Object.keys(months).sort().slice(-6);
    const labels = keys.map(k=>{ const [y,m]=k.split('-'); return `${m}/${y.slice(2)}`; });
    const inData = keys.map(k=>months[k].in || 0);
    const outData = keys.map(k=>months[k].out || 0);

    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(chartCanvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label:'IN', data: inData, backgroundColor:'rgba(34,197,94,0.7)' },
          { label:'OUT', data: outData, backgroundColor:'rgba(59,130,246,0.7)' }
        ]
      },
      options: { responsive:true, maintainAspectRatio:false }
    });

  }catch(e){ console.error(e); statsBox.innerHTML = '<div class="text-red-500">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡•ã‡§° ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä</div>'; }
}
filterName.addEventListener('input', debounce(loadReports,300));
filterFrom.addEventListener('change', loadReports);
filterTo.addEventListener('change', loadReports);

/* ---------- PDF Export ---------- */
exportPdfBtn.addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  let y=40; doc.setFontSize(16); doc.text('Inventory Report', 40, y); y+=24; doc.setFontSize(11);
  const rows = [...(window._reportIn||[]).map(r=>({t:'IN',...r})), ...(window._reportOut||[]).map(r=>({t:'OUT',...r}))];
  if(rows.length===0) return toast('‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∞‡§ø‡§ï‡§æ‡§Æ‡•Ä ‡§Ü‡§π‡•á ‚Äî ‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ');
  rows.forEach(r=>{
    const line = `${r.t} | ${r.date||''} | ${r.from||r.to||''} | ‚Çπ${fmt(r.total)} | Paid ‚Çπ${fmt(r.paid)} | Bal ‚Çπ${fmt(r.balance)}`;
    doc.text(line, 40, y); y+=14; if(y>760){ doc.addPage(); y=40; }
  });
  doc.save(`Report_${Date.now()}.pdf`);
});

/* ---------- Excel Export ---------- */
exportXlsxBtn.addEventListener('click', ()=>{
  const wb = XLSX.utils.book_new();
  const rows = [['Type','Date','Name','Total','Paid','Balance','PayType','FileURL']];
  (window._reportIn||[]).forEach(i=> rows.push(['IN', i.date||'', i.from||'', i.total||0, i.paid||0, i.balance||0, i.payType||'', i.fileURL||'']));
  (window._reportOut||[]).forEach(o=> rows.push(['OUT', o.date||'', o.to||'', o.total||0, o.paid||0, o.balance||0, o.payType||'', o.fileURL||'']));
  const ws = XLSX.utils.aoa_to_sheet(rows); XLSX.utils.book_append_sheet(wb,ws,'Report'); XLSX.writeFile(wb,`Report_${Date.now()}.xlsx`);
});

/* ---------- Backup / Restore ---------- */
backupBtn.addEventListener('click', async ()=>{
  try{
    const inSnap = await db.collection('in_entries').get();
    const outSnap = await db.collection('out_entries').get();
    const data = { backupDate:new Date().toISOString(), in: inSnap.docs.map(d=>({id:d.id,...d.data()})), out: outSnap.docs.map(d=>({id:d.id,...d.data()})) };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Backup_${Date.now()}.json`; a.click();
    toast('Backup ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ù‡§æ‡§≤‡§æ');
  }catch(e){ console.error(e); toast('Backup error'); }
});

/* Upload backup file to Storage */
uploadBackupBtn.addEventListener('click', async ()=>{
  try{
    const inSnap = await db.collection('in_entries').get();
    const outSnap = await db.collection('out_entries').get();
    const data = { backupDate:new Date().toISOString(), in: inSnap.docs.map(d=>({id:d.id,...d.data()})), out: outSnap.docs.map(d=>({id:d.id,...d.data()})) };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const path = `backups/backup_${Date.now()}.json`;
    const ref = storage.ref().child(path);
    await ref.put(blob);
    const url = await ref.getDownloadURL();
    toast('Backup uploaded to Storage');
  }catch(e){ console.error(e); toast('Upload backup error'); }
});

restoreBtn.addEventListener('click', ()=> restoreFileInput.click());
restoreFileInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const json = JSON.parse(txt);
    if(!json.in || !json.out) return toast('Invalid backup file');
    if(!confirm('Restore ‡§ï‡•á‡§≤‡•ç‡§Ø‡§æ‡§®‡•á DB ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§´‡§æ‡§à‡§≤‡§ö‡•ç‡§Ø‡§æ ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§°‡•á‡§ü‡§æ set ‡§ï‡•á‡§≤‡§æ ‡§ú‡§æ‡§à‡§≤. ‡§ö‡§æ‡§≤‡•Ç ‡§†‡•á‡§µ‡§æ‡§Ø‡§ö‡•á?')) return;
    for(const it of json.in) await db.collection('in_entries').doc(it.id).set(it);
    for(const it of json.out) await db.collection('out_entries').doc(it.id).set(it);
    toast('Restore ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ù‡§æ‡§≤‡•á'); loadRecent(); loadReports(); loadLedger();
  }catch(e){ console.error(e); toast('Restore error'); }
});

/* ---------- Daily PDF ---------- */
dailyPdfBtn.addEventListener('click', async ()=>{
  try{
    const today = new Date().toISOString().slice(0,10);
    filterFrom.value = today; filterTo.value = today;
    await loadReports();
    exportPdfBtn.click();
  }catch(e){ console.error(e); toast('Daily PDF error'); }
});

/* ---------- Ledger (person-wise) ---------- */
async function loadLedger(){
  ledgerList.innerHTML = '‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...'; ledgerDetail.innerHTML = '';
  try{
    const inSnap = await db.collection('in_entries').get();
    const outSnap = await db.collection('out_entries').get();
    const map = {}; // name -> {in:0,out:0,paidIn:0,paidOut:0, tx:[]}
    inSnap.forEach(d=>{
      const v = d.data(); const name = (v.from||'Unknown').trim();
      if(!map[name]) map[name]={in:0,out:0,paidIn:0,paidOut:0,tx:[]};
      map[name].in += Number(v.total||0); map[name].paidIn += Number(v.paid||0);
      map[name].tx.push({type:'IN',date:v.date||'',amt:v.total||0,paid:v.paid||0,id:d.id});
    });
    outSnap.forEach(d=>{
      const v = d.data(); const name = (v.to||'Unknown').trim();
      if(!map[name]) map[name]={in:0,out:0,paidIn:0,paidOut:0,tx:[]};
      map[name].out += Number(v.total||0); map[name].paidOut += Number(v.paid||0);
      map[name].tx.push({type:'OUT',date:v.date||'',amt:v.total||0,paid:v.paid||0,id:d.id});
    });
    const names = Object.keys(map).sort();
    if(names.length===0) { ledgerList.innerHTML = '<div class="text-sm text-gray-500">‡§ï‡•ã‡§£‡§§‡•Ä‡§π‡•Ä ‡§®‡•ã‡§Ç‡§¶ ‡§®‡§æ‡§π‡•Ä.</div>'; return; }
    let html = '';
    names.forEach(n=>{
      const m = map[n];
      const balance = (m.out - m.paidOut) - (m.in - m.paidIn); // net: positive means customer owes?
      html += `<div class="p-2 border rounded mb-2 flex justify-between items-center">
        <div><b>${escapeHtml(n)}</b><div class="text-xs muted">IN ‚Çπ${fmt(m.in)} | OUT ‚Çπ${fmt(m.out)}</div></div>
        <div><button class="text-sm text-blue-600" onclick="showLedgerDetail('${encodeURIComponent(n)}')">View</button></div>
      </div>`;
    });
    ledgerList.innerHTML = html;
    window._ledgerMap = map;
  }catch(e){ console.error(e); ledgerList.innerHTML = '<div class="text-red-500">‡§≤‡•ã‡§° ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä</div>'; }
}

window.showLedgerDetail = function(encodedName){
  const name = decodeURIComponent(encodedName);
  const m = window._ledgerMap && window._ledgerMap[name];
  if(!m) return;
  let html = `<div><h3 class="font-semibold">${escapeHtml(name)}</h3>`;
  html += `<div class="text-xs muted">IN ‚Çπ${fmt(m.in)} | PaidIn ‚Çπ${fmt(m.paidIn)} | OUT ‚Çπ${fmt(m.out)} | PaidOut ‚Çπ${fmt(m.paidOut)}</div>`;
  html += `<div class="mt-2"><b>Transactions:</b></div>`;
  const tx = m.tx.sort((a,b)=> b.date.localeCompare(a.date));
  tx.forEach(t=> html += `<div class="p-2 border rounded mb-1"><b>${t.type}</b> ${t.date} ‚Çπ${fmt(t.amt)} Paid ‚Çπ${fmt(t.paid)}</div>`);
  html += `<div class="mt-2"><button class="bg-amber-600 text-white p-2 rounded" onclick="shareLedger('${encodeURIComponent(name)}')">Share Ledger via WhatsApp</button></div>`;
  html += `</div>`;
  ledgerDetail.innerHTML = html;
};

async function shareLedger(encodedName){
  const name = decodeURIComponent(encodedName);
  const m = window._ledgerMap && window._ledgerMap[name];
  if(!m) return;
  let txt = `Ledger: ${name}\nIN ‚Çπ${fmt(m.in)} PaidIn ‚Çπ${fmt(m.paidIn)}\nOUT ‚Çπ${fmt(m.out)} PaidOut ‚Çπ${fmt(m.paidOut)}\nTransactions:\n`;
  m.tx.forEach(t=> txt += `${t.type} ${t.date} ‚Çπ${fmt(t.amt)} Paid ‚Çπ${fmt(t.paid)}\n`);
  const url = `https://wa.me/?text=${encodeURIComponent(txt)}`;
  window.open(url,'_blank');
}

/* ---------- Init: load recent & reports ---------- */
loadRecent(); loadReports();

/* ---------- PWA: register service worker via blob (single-file) ---------- */
if('serviceWorker' in navigator){
  const swCode = `
    self.addEventListener('install', event => { self.skipWaiting(); });
    self.addEventListener('activate', event => { self.clients.claim(); });
    self.addEventListener('fetch', event => {
      // simple network-first caching for same origin
      event.respondWith(fetch(event.request).catch(()=>caches.match(event.request)));
    });
  `;
  const blob = new Blob([swCode], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(e=>console.warn('sw register failed', e));
}

/* ---------- utility: ensure default dates ---------- */
(function setDefaults(){
  const today = new Date().toISOString().slice(0,10);
  if(!inDate.value) inDate.value = today;
  if(!outDate.value) outDate.value = today;
})();
</script>
</body>
</html>
