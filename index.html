<!doctype html>
<html lang="mr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>рд╕рд╛рдорд╛рди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди (Marathi Inventory)</title>

<!-- Tailwind CDN for quick styling -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase compat (simple single-file usage) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- SheetJS for Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#FFF8ED; }
  .card { border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
  .mar-small { font-size: .95rem; color:#444; }
</style>
</head>
<body class="p-4">

<div class="max-w-lg mx-auto">
  <h1 class="text-2xl font-bold text-amber-700 text-center mb-4">ЁЯУж рд╕рд╛рдорд╛рди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди (Marathi)</h1>

  <!-- AUTH BLOCK -->
  <div id="authBlock" class="card bg-white p-4 mb-4">
    <label class="font-semibold mar-small">рдлреЛрди рдирдВрдмрд░ (10 рдЕрдВрдХ)</label>
    <input id="phoneInput" class="w-full p-3 border rounded mt-1 mb-2" placeholder="рдЙрджрд╛. 7020970727" inputmode="numeric" />

    <div id="recaptcha-container" class="mb-2"></div>

    <button id="sendOtpBtn" class="w-full bg-amber-600 text-white p-3 rounded">OTP рдкрд╛рдард╡рд╛</button>

    <input id="otpInput" class="w-full p-3 border rounded mt-3" placeholder="OTP рдЯрд╛рдХрд╛" inputmode="numeric" />
    <button id="verifyOtpBtn" class="w-full bg-green-600 text-white p-3 rounded mt-2">рд▓реЙрдЧрд┐рди</button>
    <p class="text-xs text-gray-500 mt-2">рдЯреАрдк: OTP рдлрдВрдХреНрд╢рдирд┐рдВрдЧ рдлрдХреНрдд HTTPS рд╕рд╛рдЗрдЯрд╡рд░ рдЪрд╛рд▓реЗрд▓ (GitHub Pages рд╡рд╛рдкрд░рд╛).</p>
  </div>

  <!-- USER INFO -->
  <div id="userBox" class="card bg-white p-4 mb-4 hidden">
    <div class="flex justify-between items-center">
      <div>
        <div id="userPhone" class="font-bold"></div>
        <div id="userRole" class="text-sm text-gray-600"></div>
      </div>
      <div class="flex gap-2">
        <button id="logoutBtn" class="px-3 py-2 bg-gray-200 rounded">Logout</button>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div id="tabs" class="flex gap-2 mb-4 hidden">
    <button id="tabIn" class="flex-1 bg-amber-600 text-white p-3 rounded">IN</button>
    <button id="tabOut" class="flex-1 bg-white border p-3 rounded">OUT</button>
    <button id="tabRep" class="flex-1 bg-white border p-3 rounded">рд░рд┐рдкреЛрд░реНрдЯ</button>
  </div>

  <!-- IN PANEL -->
  <div id="panelIn" class="card bg-white p-4 mb-4 hidden">
    <h2 class="font-bold text-lg mb-2">IN тАФ рд╕рд╛рдорд╛рди рдШреЗрддрд▓реЗ</h2>
    <form id="inForm" class="space-y-3">
      <input id="inDate" type="date" class="w-full p-3 border rounded" />
      <input id="inFrom" class="w-full p-3 border rounded" placeholder="рдХреЛрдгрд╛рдХрдбреВрди" />
      <div class="grid grid-cols-2 gap-3">
        <input id="inTotal" type="number" class="p-3 border rounded" placeholder="рдПрдХреВрдг (тВ╣)" />
        <input id="inPaid" type="number" class="p-3 border rounded" placeholder="рднрд░рд▓реЗ (тВ╣)" />
      </div>
      <select id="inPayType" class="w-full p-3 border rounded">
        <option>Cash</option><option>Online</option><option>Baki</option>
      </select>
      <input id="inFile" type="file" accept="image/*,application/pdf" class="w-full" />
      <div class="flex gap-2">
        <button type="submit" class="flex-1 bg-amber-600 text-white p-3 rounded">IN рдиреЛрдВрджрд╡рд╛</button>
        <button id="inClear" type="button" class="flex-1 bg-gray-200 p-3 rounded">рд░рд┐рд╕реЗрдЯ</button>
      </div>
    </form>
    <div class="mt-3">
      <h3 class="font-semibold">рддрд╛рдЬреНрдпрд╛ IN рдиреЛрдВрджреА</h3>
      <div id="recentIn" class="text-sm mt-2"></div>
    </div>
  </div>

  <!-- OUT PANEL -->
  <div id="panelOut" class="card bg-white p-4 mb-4 hidden">
    <h2 class="font-bold text-lg mb-2">OUT тАФ рд╕рд╛рдорд╛рди рджрд┐рд▓реЗ</h2>
    <form id="outForm" class="space-y-3">
      <input id="outDate" type="date" class="w-full p-3 border rounded" />
      <input id="outTo" class="w-full p-3 border rounded" placeholder="рдХреЛрдгрд╛рд▓рд╛" />
      <div class="grid grid-cols-2 gap-3">
        <input id="outTotal" type="number" class="p-3 border rounded" placeholder="рдПрдХреВрдг (тВ╣)" />
        <input id="outPaid" type="number" class="p-3 border rounded" placeholder="рднрд░рд▓реЗ (тВ╣)" />
      </div>
      <select id="outPayType" class="w-full p-3 border rounded">
        <option>Cash</option><option>Online</option><option>Baki</option>
      </select>
      <input id="outFile" type="file" accept="image/*,application/pdf" class="w-full" />
      <div class="flex gap-2">
        <button type="submit" class="flex-1 bg-blue-600 text-white p-3 rounded">OUT рдиреЛрдВрджрд╡рд╛</button>
        <button id="outClear" type="button" class="flex-1 bg-gray-200 p-3 rounded">рд░рд┐рд╕реЗрдЯ</button>
      </div>
    </form>
    <div class="mt-3">
      <h3 class="font-semibold">рддрд╛рдЬреНрдпрд╛ OUT рдиреЛрдВрджреА</h3>
      <div id="recentOut" class="text-sm mt-2"></div>
    </div>
  </div>

  <!-- REPORT PANEL -->
  <div id="panelRep" class="card bg-white p-4 mb-4 hidden">
    <h2 class="font-bold text-lg mb-2">ЁЯУК рд░рд┐рдкреЛрд░реНрдЯ</h2>
    <input id="filterName" class="w-full p-3 border rounded mb-2" placeholder="рдирд╛рд╡ (рдЧреНрд░рд╛рд╣рдХ/рдкреБрд░рд╡рдард╛рджрд╛рд░)"/>
    <div class="grid grid-cols-2 gap-2 mb-2">
      <input id="filterFrom" type="date" class="p-3 border rounded" />
      <input id="filterTo" type="date" class="p-3 border rounded" />
    </div>

    <div id="reportStats" class="text-sm mb-3"></div>

    <div class="flex gap-2">
      <button id="exportPdfBtn" class="flex-1 bg-gray-700 text-white p-3 rounded">PDF</button>
      <button id="exportExcelBtn" class="flex-1 bg-green-600 text-white p-3 rounded">Excel</button>
    </div>

    <div class="flex gap-2 mt-3">
      <button id="backupBtn" class="flex-1 bg-purple-600 text-white p-3 rounded">ЁЯУе Backup</button>
      <button id="restoreBtn" class="flex-1 bg-orange-600 text-white p-3 rounded">ЁЯУд Restore</button>
    </div>
    <input id="restoreFileInput" type="file" accept="application/json" class="hidden" />

    <button id="dailyPdfBtn" class="w-full bg-red-600 text-white p-3 rounded mt-3">ЁЯУЕ рдЖрдЬрдЪрд╛ Daily Summary PDF</button>
  </div>

  <p class="text-center text-sm text-gray-600 mt-2">┬й Inventory App тАв Admin: 7020970727</p>
</div>

<script>
/* ================= Firebase config (user provided) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyA3PdBavWlcE3w3QjgyOykv2jkAuFcUWbY",
  authDomain: "product-buy-sell.firebaseapp.com",
  projectId: "product-buy-sell",
  storageBucket: "product-buy-sell.firebasestorage.app",
  messagingSenderId: "815213852798",
  appId: "1:815213852798:web:d347aec03aa3a46ba3802f"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ================= Helpers & UI refs ================= */
const authBlock = document.getElementById('authBlock');
const userBox = document.getElementById('userBox');
const tabs = document.getElementById('tabs');
const tabIn = document.getElementById('tabIn');
const tabOut = document.getElementById('tabOut');
const tabRep = document.getElementById('tabRep');
const panelIn = document.getElementById('panelIn');
const panelOut = document.getElementById('panelOut');
const panelRep = document.getElementById('panelRep');

const phoneInput = document.getElementById('phoneInput');
const sendOtpBtn = document.getElementById('sendOtpBtn');
const otpInput = document.getElementById('otpInput');
const verifyOtpBtn = document.getElementById('verifyOtpBtn');

const userPhone = document.getElementById('userPhone');
const userRole = document.getElementById('userRole');
const logoutBtn = document.getElementById('logoutBtn');

const inForm = document.getElementById('inForm');
const inDate = document.getElementById('inDate');
const inFrom = document.getElementById('inFrom');
const inTotal = document.getElementById('inTotal');
const inPaid = document.getElementById('inPaid');
const inPayType = document.getElementById('inPayType');
const inFile = document.getElementById('inFile');
const recentIn = document.getElementById('recentIn');
const inClear = document.getElementById('inClear');

const outForm = document.getElementById('outForm');
const outDate = document.getElementById('outDate');
const outTo = document.getElementById('outTo');
const outTotal = document.getElementById('outTotal');
const outPaid = document.getElementById('outPaid');
const outPayType = document.getElementById('outPayType');
const outFile = document.getElementById('outFile');
const recentOut = document.getElementById('recentOut');
const outClear = document.getElementById('outClear');

const filterName = document.getElementById('filterName');
const filterFrom = document.getElementById('filterFrom');
const filterTo = document.getElementById('filterTo');
const reportStats = document.getElementById('reportStats');

const exportPdfBtn = document.getElementById('exportPdfBtn');
const exportExcelBtn = document.getElementById('exportExcelBtn');
const backupBtn = document.getElementById('backupBtn');
const restoreBtn = document.getElementById('restoreBtn');
const restoreFileInput = document.getElementById('restoreFileInput');
const dailyPdfBtn = document.getElementById('dailyPdfBtn');

/* ============ UI helpers ============ */
function showPanel(name){
  panelIn.classList.add('hidden'); panelOut.classList.add('hidden'); panelRep.classList.add('hidden');
  tabIn.classList.remove('bg-amber-600','text-white'); tabOut.classList.remove('bg-amber-600','text-white'); tabRep.classList.remove('bg-amber-600','text-white');
  if(name==='in'){ panelIn.classList.remove('hidden'); tabIn.classList.add('bg-amber-600','text-white'); }
  if(name==='out'){ panelOut.classList.remove('hidden'); tabOut.classList.add('bg-amber-600','text-white'); }
  if(name==='rep'){ panelRep.classList.remove('hidden'); tabRep.classList.add('bg-amber-600','text-white'); loadReports(); }
}

/* ============ reCAPTCHA + OTP safe handling ============ */
/*
  Important: ensure recaptcha not rendered twice.
  We'll clear existing verifier before creating new one.
*/
async function clearRecaptchaIfAny(){
  try{
    if(window.recaptchaVerifier){
      // try to clear existing rendered widget if API available
      if(window.recaptchaVerifier.clear) {
        window.recaptchaVerifier.clear();
      } else if(window.grecaptcha && window.grecaptcha.reset) {
        // if grecaptcha available, reset by widget id if stored
        if(window.__recaptchaWidgetId !== undefined) {
          try{ window.grecaptcha.reset(window.__recaptchaWidgetId); }catch(e){}
        }
      }
      window.recaptchaVerifier = null;
      window.__recaptchaWidgetId = undefined;
    }
  }catch(e){
    // ignore errors
    console.warn('recaptcha clear err', e);
    window.recaptchaVerifier = null;
    window.__recaptchaWidgetId = undefined;
  }
}

async function setupRecaptcha(){
  await clearRecaptchaIfAny();
  // invisible reCAPTCHA
  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
    'size': 'invisible',
    'callback': (token)=> { /* invisible callback */ }
  });
  // render and store widget id if possible
  try{
    const widgetId = await window.recaptchaVerifier.render();
    window.__recaptchaWidgetId = widgetId;
  }catch(e){
    console.warn('recaptcha render failed', e);
  }
}

/* ============ Send OTP ============ */
sendOtpBtn.addEventListener('click', async ()=>{
  const num = phoneInput.value.trim();
  if(!/^[0-9]{10}$/.test(num)) return alert('рдХреГрдкрдпрд╛ рд╡реИрдз 10 рдЕрдВрдХреА рдлреЛрди рдирдВрдмрд░ рдЯрд╛рдХрд╛.');

  try{
    await setupRecaptcha();
    const phone = '+91' + num;
    // signInWithPhoneNumber requires the recaptcha verifier instance
    const confirmationResult = await auth.signInWithPhoneNumber(phone, window.recaptchaVerifier);
    window._confirmationResult = confirmationResult;
    alert('OTP рдкрд╛рдард╡рд▓рд╛ рдЭрд╛рд▓рд╛ рдЖрд╣реЗ тАФ рдХреГрдкрдпрд╛ рдорд┐рд│рд╛рд▓реЗрд▓рд╛ рдХреЛрдб рдЯрд╛рдХрд╛.');
  }catch(err){
    console.error('sendOtpErr', err);
    alert('Firebase: ' + (err && err.message ? err.message : 'Internal Auth Error'));
  }
});

/* ============ Verify OTP ============ */
verifyOtpBtn.addEventListener('click', async ()=>{
  const code = otpInput.value.trim();
  if(!code) return alert('рдХреГрдкрдпрд╛ OTP рдЯрд╛рдХрд╛.');
  try{
    if(!window._confirmationResult) return alert('рдкрд╣рд┐рд▓реЗ OTP рдкрд╛рдард╡рд╛.');
    const result = await window._confirmationResult.confirm(code);
    // login success
    alert('рд▓реЙрдЧрд┐рди рдпрд╢рд╕реНрд╡реА');
  }catch(err){
    console.error('verifyErr', err);
    alert('OTP рдЪреБрдХреАрдЪрд╛ рдХрд┐рдВрд╡рд╛ рдПрдХреНрд╕реНрдкрд╛рдпрд░реНрдб рдЖрд╣реЗ.');
  }
});

/* ============ Auth State ============ */
auth.onAuthStateChanged(async (user)=>{
  if(!user){
    authBlock.classList.remove('hidden');
    userBox.classList.add('hidden');
    tabs.classList.add('hidden');
    return;
  }
  // logged in
  authBlock.classList.add('hidden');
  userBox.classList.remove('hidden');
  tabs.classList.remove('hidden');

  userPhone.textContent = user.phoneNumber || '';
  // simple admin check by phone number (you can change)
  userRole.textContent = (user.phoneNumber === '+917020970727') ? 'Admin' : 'User';

  // show IN panel by default
  showPanel('in');
  await loadRecent();
});

/* ============ Logout ============ */
logoutBtn.addEventListener('click', ()=>auth.signOut());

/* ============ File upload helper ============ */
async function uploadFile(file, folder){
  if(!file) return null;
  const path = `${folder}/${Date.now()}_${file.name}`;
  const ref = storage.ref().child(path);
  await ref.put(file);
  return await ref.getDownloadURL();
}

/* ============ IN Submit ============ */
inForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const date = inDate.value || new Date().toISOString().slice(0,10);
  const from = inFrom.value.trim() || '---';
  const total = Number(inTotal.value) || 0;
  const paid = Number(inPaid.value) || 0;
  const payType = inPayType.value || 'Cash';
  try{
    const fileUrl = await uploadFile(inFile.files[0], 'in_files');
    await db.collection('in_entries').add({
      date, from, total, paid, balance: (total - paid), payType, fileUrl: fileUrl || null,
      createdAt: Date.now()
    });
    alert('IN рдиреЛрдВрдж рдЬрддрди рдЭрд╛рд▓реА');
    inForm.reset();
    loadRecent();
  }catch(err){
    console.error('inSaveErr', err);
    alert('IN рд╕реЗрд╡реЗрдд рддреНрд░реБрдЯреА');
  }
});

/* ============ OUT Submit ============ */
outForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const date = outDate.value || new Date().toISOString().slice(0,10);
  const to = outTo.value.trim() || '---';
  const total = Number(outTotal.value) || 0;
  const paid = Number(outPaid.value) || 0;
  const payType = outPayType.value || 'Cash';
  try{
    const fileUrl = await uploadFile(outFile.files[0], 'out_files');
    await db.collection('out_entries').add({
      date, to, total, paid, balance: (total - paid), payType, fileUrl: fileUrl || null,
      createdAt: Date.now()
    });
    alert('OUT рдиреЛрдВрдж рдЬрддрди рдЭрд╛рд▓реА');
    outForm.reset();
    loadRecent();
  }catch(err){
    console.error('outSaveErr', err);
    alert('OUT рд╕реЗрд╡реЗрдд рддреНрд░реБрдЯреА');
  }
});

/* ============ Load recent entries ============ */
async function loadRecent(){
  try{
    const inSnap = await db.collection('in_entries').orderBy('createdAt','desc').limit(5).get();
    const outSnap = await db.collection('out_entries').orderBy('createdAt','desc').limit(5).get();

    let htmlIn = '';
    inSnap.forEach(d=>{
      const x = d.data();
      htmlIn += `<div class="p-2 border rounded mb-1"><b>${escapeHtml(x.from||'---')}</b> тАФ тВ╣${x.total||0} | Paid: тВ╣${x.paid||0}</div>`;
    });
    recentIn.innerHTML = htmlIn || '<div class="text-sm text-gray-500">рдХреЛрдгрддреАрд╣реА IN рдиреЛрдВрдж рдирд╛рд╣реА.</div>';

    let htmlOut = '';
    outSnap.forEach(d=>{
      const x = d.data();
      htmlOut += `<div class="p-2 border rounded mb-1"><b>${escapeHtml(x.to||'---')}</b> тАФ тВ╣${x.total||0} | Paid: тВ╣${x.paid||0}</div>`;
    });
    recentOut.innerHTML = htmlOut || '<div class="text-sm text-gray-500">рдХреЛрдгрддреАрд╣реА OUT рдиреЛрдВрдж рдирд╛рд╣реА.</div>';
  }catch(e){
    console.error('loadRecentErr', e);
  }
}

/* ============ Reports (filters + stats) ============ */
filterName.addEventListener('input', debounce(loadReports, 300));
filterFrom.addEventListener('change', loadReports);
filterTo.addEventListener('change', loadReports);

async function loadReports(){
  try{
    const name = (filterName.value || '').trim().toLowerCase();
    const from = filterFrom.value || null;
    const to = filterTo.value || null;

    const inSnap = await db.collection('in_entries').get();
    const outSnap = await db.collection('out_entries').get();

    let IN = inSnap.docs.map(d=>d.data());
    let OUT = outSnap.docs.map(d=>d.data());

    if(name){
      IN = IN.filter(i => (i.from || '').toLowerCase().includes(name));
      OUT = OUT.filter(o => (o.to || '').toLowerCase().includes(name));
    }
    if(from) {
      IN = IN.filter(i => (i.date || '') >= from);
      OUT = OUT.filter(o => (o.date || '') >= from);
    }
    if(to) {
      IN = IN.filter(i => (i.date || '') <= to);
      OUT = OUT.filter(o => (o.date || '') <= to);
    }

    // store for export
    window._reportIn = IN;
    window._reportOut = OUT;

    const sumIn = IN.reduce((acc, it) => acc + Number(it.total||0), 0);
    const sumOut = OUT.reduce((acc, it) => acc + Number(it.total||0), 0);
    const sumPaid = [...IN, ...OUT].reduce((acc, it) => acc + Number(it.paid||0), 0);
    const sumBal = [...IN, ...OUT].reduce((acc, it) => acc + Number(it.balance||0), 0);

    reportStats.innerHTML = `<b>IN:</b> тВ╣${sumIn}<br><b>OUT:</b> тВ╣${sumOut}<br><b>Paid:</b> тВ╣${sumPaid}<br><b>Balance:</b> тВ╣${sumBal}`;
  }catch(e){
    console.error('loadReportsErr', e);
  }
}

/* ============ Export PDF (simple list) ============ */
exportPdfBtn.addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  let y = 36;
  doc.setFontSize(16); doc.text('Inventory Report', 40, y); y+=20;
  const rows = [...(window._reportIn||[]).map(r=>({type:'IN',...r})), ...(window._reportOut||[]).map(r=>({type:'OUT',...r}))];
  doc.setFontSize(11);
  rows.forEach(r=>{
    const line = `${r.type} | ${r.date||''} | ${r.from||r.to||''} | тВ╣${r.total||0} | Paid тВ╣${r.paid||0}`;
    if(y > 760){ doc.addPage(); y = 36; }
    doc.text(line, 40, y); y += 14;
  });
  doc.save(`Report_${Date.now()}.pdf`);
});

/* ============ Export Excel (SheetJS) ============ */
exportExcelBtn.addEventListener('click', ()=>{
  const wb = XLSX.utils.book_new();
  const rows = [['Type','Date','Name','Total','Paid','Balance','PaymentType']];
  (window._reportIn||[]).forEach(r => rows.push(['IN', r.date||'', r.from||'', r.total||0, r.paid||0, r.balance||0, r.payType||'']));
  (window._reportOut||[]).forEach(r => rows.push(['OUT', r.date||'', r.to||'', r.total||0, r.paid||0, r.balance||0, r.payType||'']));
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Report');
  XLSX.writeFile(wb, `Report_${Date.now()}.xlsx`);
});

/* ============ Backup (JSON) ============ */
backupBtn.addEventListener('click', async ()=>{
  try{
    const inSnap = await db.collection('in_entries').get();
    const outSnap = await db.collection('out_entries').get();
    const data = {
      backupDate: new Date().toISOString(),
      in_entries: inSnap.docs.map(d => ({ id:d.id, ...d.data() })),
      out_entries: outSnap.docs.map(d => ({ id:d.id, ...d.data() }))
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `InventoryBackup_${Date.now()}.json`; a.click();
    URL.revokeObjectURL(url);
    alert('Backup рдбрд╛рдЙрдирд▓реЛрдб рдЭрд╛рд▓рд╛');
  }catch(e){ console.error('backupErr', e); alert('Backup error'); }
});

/* ============ Restore (JSON) ============ */
restoreBtn.addEventListener('click', ()=> restoreFileInput.click());
restoreFileInput.addEventListener('change', async (ev)=>{
  const file = ev.target.files[0]; if(!file) return;
  try{
    const text = await file.text();
    const json = JSON.parse(text);
    if(!json.in_entries || !json.out_entries) return alert('рдЕрд╡реИрдз рдлрд╛рдЗрд▓');
    const confirmRestore = confirm('Restore рдХреЗрд▓реНрдпрд╛рдиреЗ рдбреЗрдЯрд╛ рдкреБрдиреНрд╣рд╛ рдЬреЛрдбрд▓рд╛ рдЬрд╛рдИрд▓. рдЪрд╛рд▓реВ рдареЗрд╡рд╛рдпрдЪреЗ?');
    if(!confirmRestore) return;
    // write back using same ids to preserve
    for(const it of json.in_entries){ await db.collection('in_entries').doc(it.id).set(it); }
    for(const it of json.out_entries){ await db.collection('out_entries').doc(it.id).set(it); }
    alert('Restore рдкреВрд░реНрдг рдЭрд╛рд▓реЗ');
    loadRecent(); loadReports();
  }catch(e){ console.error('restoreErr', e); alert('Restore error'); }
});

/* ============ Daily Summary PDF ============ */
dailyPdfBtn.addEventListener('click', async ()=>{
  try{
    const today = new Date().toISOString().slice(0,10);
    const inSnap = await db.collection('in_entries').where('date','==',today).get();
    const outSnap = await db.collection('out_entries').where('date','==',today).get();
    const IN = inSnap.docs.map(d=>d.data());
    const OUT = outSnap.docs.map(d=>d.data());
    if(IN.length===0 && OUT.length===0) return alert('рдЖрдЬ рдХреЛрдгрддреАрд╣реА рдиреЛрдВрдж рдирд╛рд╣реА');
    const sumIn = IN.reduce((a,b)=>a+Number(b.total||0), 0);
    const sumOut = OUT.reduce((a,b)=>a+Number(b.total||0), 0);
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','pt','a4');
    let y=40;
    doc.setFontSize(16); doc.text(`Daily Summary - ${today}`, 40, y); y+=20;
    doc.setFontSize(12); doc.text(`Total IN: тВ╣${sumIn}`, 40, y); y+=16;
    doc.text(`Total OUT: тВ╣${sumOut}`, 40, y); y+=20;
    doc.setFontSize(12); doc.text('IN Entries:', 40, y); y+=14;
    IN.forEach(it=>{ if(y>760){doc.addPage(); y=40;} doc.text(`${it.date} | ${it.from||''} | тВ╣${it.total||0} | Paid тВ╣${it.paid||0}`, 40, y); y+=12; });
    y+=10; doc.text('OUT Entries:',40,y); y+=14;
    OUT.forEach(it=>{ if(y>760){doc.addPage(); y=40;} doc.text(`${it.date} | ${it.to||''} | тВ╣${it.total||0} | Paid тВ╣${it.paid||0}`, 40, y); y+=12; });
    doc.save(`DailySummary_${today}.pdf`);
  }catch(e){ console.error('dailyErr', e); alert('Daily report error'); }
});

/* ============ Utilities ============ */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function debounce(fn, t){ let timer; return (...args)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...args), t||300); }; }

/* ============ Init defaults ============ */
// prefill dates with today
const today = new Date().toISOString().slice(0,10);
inDate.value = today; outDate.value = today; filterFrom.value = ''; filterTo.value = '';

/* make sure tabs work after login */
tabIn.addEventListener('click', ()=> showPanel('in'));
tabOut.addEventListener('click', ()=> showPanel('out'));
tabRep.addEventListener('click', ()=> showPanel('rep'));

/* Quick clears */
inClear.addEventListener('click', ()=> inForm.reset());
outClear.addEventListener('click', ()=> outForm.reset());

/* Small safety: ensure recaptcha cleared if user navigates away */
window.addEventListener('beforeunload', ()=> { try{ if(window.recaptchaVerifier && window.recaptchaVerifier.clear) window.recaptchaVerifier.clear(); }catch(e){} });

</script>
</body>
</html>
