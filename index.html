<!doctype html>
<html lang="mr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡§∏‡§æ‡§Æ‡§æ‡§® ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‚Äî Final (IN/OUT + Storage + Edit/Delete + Reports)</title>

<!-- Tailwind for quick styling -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase compat libs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#fff7ed; }
  .card { border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.06); background: #fff; }
  .muted { color:#6b7280; font-size:.95rem; }
  .btn { padding:.6rem 0.8rem; border-radius:10px; font-weight:600; }
  /* small screens fix */
  @media (max-width:420px){ .max-w { padding: .75rem; } }
</style>
</head>
<body class="p-4">

<div class="max-w-lg mx-auto max-w p-4">
  <header class="text-center mb-4">
    <h1 class="text-2xl font-bold text-amber-700">üì¶ ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®</h1>
    <p class="muted">IN / OUT, ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§°, Edit/Delete, ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏ ‚Äî ‡§Æ‡§∞‡§æ‡§†‡•Ä UI</p>
  </header>

  <!-- TABS -->
  <div class="flex gap-2 mb-4">
    <button id="tabIn" class="flex-1 btn bg-amber-600 text-white">IN (‡§ò‡•á‡§£‡•á)</button>
    <button id="tabOut" class="flex-1 btn bg-white border text-amber-700">OUT (‡§¶‡•á‡§£‡•á)</button>
    <button id="tabRep" class="flex-1 btn bg-white border text-amber-700">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</button>
  </div>

  <!-- IN PANEL -->
  <section id="panelIn" class="card p-4 mb-4">
    <h2 class="font-bold text-lg mb-3 text-amber-700">IN ‚Äî ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ò‡•á‡§§‡§≤‡•á</h2>
    <div class="space-y-2">
      <label class="muted">‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
      <input id="inDate" type="date" class="w-full p-2 border rounded" />

      <label class="muted">‡§ï‡•ã‡§£‡§æ‡§ï‡§°‡•Ç‡§®</label>
      <input id="inFrom" class="w-full p-2 border rounded" placeholder="‡§™‡•Å‡§∞‡§µ‡§†‡§æ‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§®‡§æ‡§µ" />

      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="muted">‡§è‡§ï‡•Ç‡§£ (‚Çπ)</label>
          <input id="inTotal" type="number" class="w-full p-2 border rounded" />
        </div>
        <div>
          <label class="muted">‡§≠‡§∞‡§≤‡•á (‚Çπ)</label>
          <input id="inPaid" type="number" class="w-full p-2 border rounded" />
        </div>
      </div>

      <label class="muted">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</label>
      <select id="inPayType" class="w-full p-2 border rounded">
        <option>Cash</option><option>Online</option><option>Baki</option>
      </select>

      <label class="muted">‡§¨‡§ø‡§≤ / ‡§´‡•ã‡§ü‡•ã (‡§ê‡§ö‡•ç‡§õ‡§ø‡§ï)</label>
      <input id="inFile" type="file" accept="image/*,application/pdf" class="w-full" />

      <div class="flex gap-2 mt-2">
        <button id="btnIn" class="flex-1 bg-amber-600 text-white btn">IN ‡§ú‡§§‡§® ‡§ï‡§∞‡§æ</button>
        <button id="btnInClear" class="flex-1 bg-gray-200 btn">‡§∞‡§¶‡•ç‡§¶ / ‡§∏‡§æ‡§´ ‡§ï‡§∞‡§æ</button>
      </div>
    </div>

    <div class="mt-4">
      <h3 class="font-semibold">‡§§‡§æ‡§ú‡•ç‡§Ø‡§æ IN ‡§®‡•ã‡§Ç‡§¶‡•Ä</h3>
      <div id="recentIn" class="mt-2 text-sm"></div>
    </div>
  </section>

  <!-- OUT PANEL -->
  <section id="panelOut" class="card p-4 mb-4 hidden">
    <h2 class="font-bold text-lg mb-3 text-blue-700">OUT ‚Äî ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§¶‡§ø‡§≤‡•á</h2>
    <div class="space-y-2">
      <label class="muted">‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
      <input id="outDate" type="date" class="w-full p-2 border rounded" />

      <label class="muted">‡§ï‡•ã‡§£‡§æ‡§≤‡§æ</label>
      <input id="outTo" class="w-full p-2 border rounded" placeholder="‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡§æ‡§ö‡•á ‡§®‡§æ‡§µ" />

      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="muted">‡§è‡§ï‡•Ç‡§£ (‚Çπ)</label>
          <input id="outTotal" type="number" class="w-full p-2 border rounded" />
        </div>
        <div>
          <label class="muted">‡§≠‡§∞‡§≤‡•á (‚Çπ)</label>
          <input id="outPaid" type="number" class="w-full p-2 border rounded" />
        </div>
      </div>

      <label class="muted">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</label>
      <select id="outPayType" class="w-full p-2 border rounded">
        <option>Cash</option><option>Online</option><option>Baki</option>
      </select>

      <label class="muted">‡§¨‡§ø‡§≤ / ‡§´‡•ã‡§ü‡•ã (‡§ê‡§ö‡•ç‡§õ‡§ø‡§ï)</label>
      <input id="outFile" type="file" accept="image/*,application/pdf" class="w-full" />

      <div class="flex gap-2 mt-2">
        <button id="btnOut" class="flex-1 bg-blue-600 text-white btn">OUT ‡§ú‡§§‡§® ‡§ï‡§∞‡§æ</button>
        <button id="btnOutClear" class="flex-1 bg-gray-200 btn">‡§∞‡§¶‡•ç‡§¶ / ‡§∏‡§æ‡§´ ‡§ï‡§∞‡§æ</button>
      </div>
    </div>

    <div class="mt-4">
      <h3 class="font-semibold">‡§§‡§æ‡§ú‡•ç‡§Ø‡§æ OUT ‡§®‡•ã‡§Ç‡§¶‡•Ä</h3>
      <div id="recentOut" class="mt-2 text-sm"></div>
    </div>
  </section>

  <!-- REPORT PANEL -->
  <section id="panelRep" class="card p-4 mb-4 hidden">
    <h2 class="font-bold text-lg mb-3">üìä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</h2>

    <div class="grid grid-cols-2 gap-2 mb-3">
      <input id="filterFrom" type="date" class="p-2 border rounded" />
      <input id="filterTo" type="date" class="p-2 border rounded" />
    </div>

    <input id="filterName" placeholder="‡§®‡§æ‡§µ ‡§∂‡•ã‡§ß‡§æ (‡§™‡•Å‡§∞‡§µ‡§†‡§æ‡§¶‡§æ‡§∞/‡§ó‡•ç‡§∞‡§æ‡§π‡§ï)" class="w-full p-2 border rounded mb-3" />

    <div id="statsBox" class="p-2 border rounded text-sm mb-3"></div>

    <div class="flex gap-2 mb-2">
      <button id="exportPdfBtn" class="flex-1 bg-gray-800 text-white p-2 rounded">PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
      <button id="exportXlsxBtn" class="flex-1 bg-green-600 text-white p-2 rounded">Excel ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
    </div>

    <div class="flex gap-2 mb-2">
      <button id="backupBtn" class="flex-1 bg-purple-600 text-white p-2 rounded">üì• Backup</button>
      <button id="restoreBtn" class="flex-1 bg-orange-600 text-white p-2 rounded">üì§ Restore</button>
      <input id="restoreFileInput" type="file" accept="application/json" class="hidden" />
    </div>

    <button id="dailyPdfBtn" class="w-full bg-red-600 text-white p-2 rounded">üìÖ ‡§Ü‡§ú‡§ö‡§æ Daily PDF</button>

    <div class="mt-3 text-xs muted">‡§®‡•ã‡§ü: ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§°‡§∏‡§æ‡§†‡•Ä Firebase Storage ‡§µ‡§æ‡§™‡§∞‡§≤‡•á ‡§Ü‡§π‡•á.</div>
  </section>

  <footer class="text-center text-sm text-gray-500 mt-4">¬© Inventory ‚Ä¢ Admin: 7020970727</footer>
</div>

<script>
/* ------------------- Firebase init (use your config) ------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyA3PdBavWlcE3w3QjgyOykv2jkAuFcUWbY",
  authDomain: "product-buy-sell.firebaseapp.com",
  projectId: "product-buy-sell",
  storageBucket: "product-buy-sell.appspot.com",
  messagingSenderId: "815213852798",
  appId: "1:815213852798:web:d347aec03aa3a46ba3802f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

/* ------------------- UI refs ------------------- */
const tabIn = document.getElementById('tabIn'), tabOut = document.getElementById('tabOut'), tabRep = document.getElementById('tabRep');
const panelIn = document.getElementById('panelIn'), panelOut = document.getElementById('panelOut'), panelRep = document.getElementById('panelRep');

const inDate = document.getElementById('inDate'), inFrom = document.getElementById('inFrom'), inTotal = document.getElementById('inTotal'), inPaid = document.getElementById('inPaid'), inPayType = document.getElementById('inPayType'), inFile = document.getElementById('inFile'), btnIn = document.getElementById('btnIn'), btnInClear = document.getElementById('btnInClear'), recentIn = document.getElementById('recentIn');
const outDate = document.getElementById('outDate'), outTo = document.getElementById('outTo'), outTotal = document.getElementById('outTotal'), outPaid = document.getElementById('outPaid'), outPayType = document.getElementById('outPayType'), outFile = document.getElementById('outFile'), btnOut = document.getElementById('btnOut'), btnOutClear = document.getElementById('btnOutClear'), recentOut = document.getElementById('recentOut');

const filterFrom = document.getElementById('filterFrom'), filterTo = document.getElementById('filterTo'), filterName = document.getElementById('filterName');
const statsBox = document.getElementById('statsBox'), exportPdfBtn = document.getElementById('exportPdfBtn'), exportXlsxBtn = document.getElementById('exportXlsxBtn');
const backupBtn = document.getElementById('backupBtn'), restoreBtn = document.getElementById('restoreBtn'), restoreFileInput = document.getElementById('restoreFileInput'), dailyPdfBtn = document.getElementById('dailyPdfBtn');

/* ------------------- Helpers ------------------- */
function showPanel(name){
  panelIn.classList.add('hidden'); panelOut.classList.add('hidden'); panelRep.classList.add('hidden');
  tabIn.classList.remove('bg-amber-600','text-white'); tabOut.classList.remove('bg-blue-600','text-white'); tabRep.classList.remove('bg-green-600','text-white');
  if(name==='in'){ panelIn.classList.remove('hidden'); tabIn.classList.add('bg-amber-600','text-white'); }
  if(name==='out'){ panelOut.classList.remove('hidden'); tabOut.classList.add('bg-blue-600','text-white'); }
  if(name==='rep'){ panelRep.classList.remove('hidden'); tabRep.classList.add('bg-green-600','text-white'); loadReports(); }
}
tabIn.addEventListener('click', ()=> showPanel('in'));
tabOut.addEventListener('click', ()=> showPanel('out'));
tabRep.addEventListener('click', ()=> showPanel('rep'));
showPanel('in');

function toast(msg){ alert(msg); }
function fmt(n){ return Number(n||0).toFixed(2); }
function uid(){ return Math.random().toString(36).slice(2,9); }

/* ------------------- File upload helper ------------------- */
async function uploadFile(file, folder){
  if(!file) return null;
  const path = `${folder}/${Date.now()}_${uid()}_${file.name.replaceAll(' ','_')}`;
  const ref = storage.ref().child(path);
  await ref.put(file);
  return await ref.getDownloadURL();
}

/* ------------------- Delete storage file by URL ------------------- */
async function deleteFileByUrl(url){
  if(!url) return;
  try{
    const ref = storage.refFromURL(url);
    await ref.delete();
  }catch(e){
    console.warn('deleteFileErr', e.message || e);
  }
}

/* ------------------- Edit state ------------------- */
let editInId = null;
let editOutId = null;

/* ------------------- IN Save / Update ------------------- */
btnIn.addEventListener('click', async ()=>{
  const date = inDate.value || new Date().toISOString().slice(0,10);
  const from = (inFrom.value || '').trim();
  const total = Number(inTotal.value) || 0;
  const paid = Number(inPaid.value) || 0;
  const payType = inPayType.value || 'Cash';
  const file = inFile.files[0];

  if(!from){ return toast('‡§ï‡•É‡§™‡§Ø‡§æ "‡§ï‡•ã‡§£‡§æ‡§ï‡§°‡•Ç‡§®" ‡§≠‡§∞‡§æ‡§µ‡•á'); }

  const payload = { date, from, total, paid, balance: total - paid, payType, createdAt: Date.now() };

  try{
    // If updating existing -> if new file uploaded, upload and delete old file
    if(editInId){
      const docRef = db.collection('in_entries').doc(editInId);
      const doc = await docRef.get();
      const old = doc.data();
      if(file){
        const newUrl = await uploadFile(file,'in');
        payload.fileURL = newUrl;
        if(old && old.fileURL) await deleteFileByUrl(old.fileURL);
      } else if(old && old.fileURL){
        payload.fileURL = old.fileURL;
      }
      await docRef.update(payload);
      toast('IN ‡§®‡•ã‡§Ç‡§¶ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ù‡§æ‡§≤‡•Ä');
      editInId = null;
      btnIn.textContent = 'IN ‡§ú‡§§‡§® ‡§ï‡§∞‡§æ';
    } else {
      if(file) payload.fileURL = await uploadFile(file,'in');
      await db.collection('in_entries').add(payload);
      toast('IN ‡§ú‡§§‡§® ‡§ù‡§æ‡§≤‡•Ä');
    }
    inFormReset();
    loadRecent();
    loadReports();
  }catch(e){
    console.error(e);
    toast('IN ‡§∏‡•á‡§µ‡•á‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ' + (e.message || e));
  }
});

/* ------------------- OUT Save / Update ------------------- */
btnOut.addEventListener('click', async ()=>{
  const date = outDate.value || new Date().toISOString().slice(0,10);
  const to = (outTo.value || '').trim();
  const total = Number(outTotal.value) || 0;
  const paid = Number(outPaid.value) || 0;
  const payType = outPayType.value || 'Cash';
  const file = outFile.files[0];

  if(!to){ return toast('‡§ï‡•É‡§™‡§Ø‡§æ "‡§ï‡•ã‡§£‡§æ‡§≤‡§æ" ‡§≠‡§∞‡§æ‡§µ‡•á'); }

  const payload = { date, to, total, paid, balance: total - paid, payType, createdAt: Date.now() };

  try{
    if(editOutId){
      const docRef = db.collection('out_entries').doc(editOutId);
      const doc = await docRef.get();
      const old = doc.data();
      if(file){
        const newUrl = await uploadFile(file,'out');
        payload.fileURL = newUrl;
        if(old && old.fileURL) await deleteFileByUrl(old.fileURL);
      } else if(old && old.fileURL){
        payload.fileURL = old.fileURL;
      }
      await docRef.update(payload);
      toast('OUT ‡§®‡•ã‡§Ç‡§¶ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ù‡§æ‡§≤‡•Ä');
      editOutId = null;
      btnOut.textContent = 'OUT ‡§ú‡§§‡§® ‡§ï‡§∞‡§æ';
    } else {
      if(file) payload.fileURL = await uploadFile(file,'out');
      await db.collection('out_entries').add(payload);
      toast('OUT ‡§ú‡§§‡§® ‡§ù‡§æ‡§≤‡•Ä');
    }
    outFormReset();
    loadRecent();
    loadReports();
  }catch(e){
    console.error(e);
    toast('OUT ‡§∏‡•á‡§µ‡•á‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ' + (e.message || e));
  }
});

/* ------------------- Reset helpers ------------------- */
function inFormReset(){
  inDate.value=''; inFrom.value=''; inTotal.value=''; inPaid.value=''; inPayType.value='Cash'; inFile.value=null;
}
function outFormReset(){
  outDate.value=''; outTo.value=''; outTotal.value=''; outPaid.value=''; outPayType.value='Cash'; outFile.value=null;
}

/* ------------------- Load Recent with Edit/Delete ------------------- */
async function loadRecent(){
  recentIn.innerHTML = '<div class="text-sm text-gray-500">‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á‚Ä¶</div>';
  recentOut.innerHTML = '<div class="text-sm text-gray-500">‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á‚Ä¶</div>';
  try{
    const inSnap = await db.collection('in_entries').orderBy('createdAt','desc').limit(10).get();
    let htmlIn = '';
    inSnap.forEach(d=>{
      const id = d.id;
      const v = d.data();
      htmlIn += `<div class="flex justify-between items-center p-2 border rounded mb-2">
        <div>
          <div><b>‚Çπ${fmt(v.total)} </b> | ${escapeHtml(v.from||'')}</div>
          <div class="text-xs text-gray-600">${v.date || ''} ‚Ä¢ Paid ‚Çπ${fmt(v.paid)} ‚Ä¢ Bal ‚Çπ${fmt(v.balance)}</div>
        </div>
        <div class="flex flex-col gap-1 ml-2">
          <button class="text-sm text-blue-600" onclick="editIn('${id}')">Edit</button>
          <button class="text-sm text-red-600" onclick="deleteIn('${id}')">Delete</button>
          ${v.fileURL ? `<a class="text-xs text-amber-600" href="${v.fileURL}" target="_blank">View</a>` : ''}
        </div>
      </div>`;
    });
    recentIn.innerHTML = htmlIn || '<div class="text-sm text-gray-500">‡§ï‡•ã‡§£‡§§‡•Ä‡§π‡•Ä IN ‡§®‡•ã‡§Ç‡§¶ ‡§®‡§æ‡§π‡•Ä.</div>';

    const outSnap = await db.collection('out_entries').orderBy('createdAt','desc').limit(10).get();
    let htmlOut = '';
    outSnap.forEach(d=>{
      const id = d.id;
      const v = d.data();
      htmlOut += `<div class="flex justify-between items-center p-2 border rounded mb-2">
        <div>
          <div><b>‚Çπ${fmt(v.total)} </b> | ${escapeHtml(v.to||'')}</div>
          <div class="text-xs text-gray-600">${v.date || ''} ‚Ä¢ Paid ‚Çπ${fmt(v.paid)} ‚Ä¢ Bal ‚Çπ${fmt(v.balance)}</div>
        </div>
        <div class="flex flex-col gap-1 ml-2">
          <button class="text-sm text-blue-600" onclick="editOut('${id}')">Edit</button>
          <button class="text-sm text-red-600" onclick="deleteOut('${id}')">Delete</button>
          ${v.fileURL ? `<a class="text-xs text-amber-600" href="${v.fileURL}" target="_blank">View</a>` : ''}
        </div>
      </div>`;
    });
    recentOut.innerHTML = htmlOut || '<div class="text-sm text-gray-500">‡§ï‡•ã‡§£‡§§‡•Ä‡§π‡•Ä OUT ‡§®‡•ã‡§Ç‡§¶ ‡§®‡§æ‡§π‡•Ä.</div>';

  }catch(e){ console.error(e); recentIn.innerHTML = '<div class="text-sm text-red-500">‡§≤‡•ã‡§° ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä</div>'; recentOut.innerHTML = '<div class="text-sm text-red-500">‡§≤‡•ã‡§° ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä</div>'; }
}
window.loadRecent = loadRecent;

/* ------------------- Edit / Delete functions ------------------- */
window.editIn = async function(id){
  try{
    const doc = await db.collection('in_entries').doc(id).get();
    const v = doc.data();
    inDate.value = v.date || '';
    inFrom.value = v.from || '';
    inTotal.value = v.total || '';
    inPaid.value = v.paid || '';
    inPayType.value = v.payType || 'Cash';
    editInId = id;
    btnIn.textContent = 'Update IN';
    showPanel('in');
    window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ console.error(e); toast('Edit error'); }
};

window.editOut = async function(id){
  try{
    const doc = await db.collection('out_entries').doc(id).get();
    const v = doc.data();
    outDate.value = v.date || '';
    outTo.value = v.to || '';
    outTotal.value = v.total || '';
    outPaid.value = v.paid || '';
    outPayType.value = v.payType || 'Cash';
    editOutId = id;
    btnOut.textContent = 'Update OUT';
    showPanel('out');
    window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ console.error(e); toast('Edit error'); }
};

window.deleteIn = async function(id){
  if(!confirm('‡§π‡•Ä IN ‡§®‡•ã‡§Ç‡§¶ ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡•Ä?')) return;
  try{
    const doc = await db.collection('in_entries').doc(id).get();
    const v = doc.data();
    if(v && v.fileURL) await deleteFileByUrl(v.fileURL);
    await db.collection('in_entries').doc(id).delete();
    toast('IN ‡§®‡•ã‡§Ç‡§¶ ‡§π‡§ü‡§µ‡§≤‡•Ä');
    loadRecent(); loadReports();
  }catch(e){ console.error(e); toast('Delete error'); }
};

window.deleteOut = async function(id){
  if(!confirm('‡§π‡•Ä OUT ‡§®‡•ã‡§Ç‡§¶ ‡§π‡§ü‡§µ‡§æ‡§Ø‡§ö‡•Ä?')) return;
  try{
    const doc = await db.collection('out_entries').doc(id).get();
    const v = doc.data();
    if(v && v.fileURL) await deleteFileByUrl(v.fileURL);
    await db.collection('out_entries').doc(id).delete();
    toast('OUT ‡§®‡•ã‡§Ç‡§¶ ‡§π‡§ü‡§µ‡§≤‡•Ä');
    loadRecent(); loadReports();
  }catch(e){ console.error(e); toast('Delete error'); }
};

/* ------------------- Reports (filter + summary) ------------------- */
async function loadReports(){
  statsBox.innerHTML = '‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...';
  try{
    const name = (filterName.value || '').trim().toLowerCase();
    const from = filterFrom.value || null;
    const to = filterTo.value || null;

    const inSnap = await db.collection('in_entries').orderBy('date','desc').get();
    const outSnap = await db.collection('out_entries').orderBy('date','desc').get();

    let IN = inSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    let OUT = outSnap.docs.map(d=>({ id:d.id, ...d.data() }));

    if(name){
      IN = IN.filter(i => (i.from||'').toLowerCase().includes(name));
      OUT = OUT.filter(o => (o.to||'').toLowerCase().includes(name));
    }
    if(from) { IN = IN.filter(i => (i.date||'') >= from); OUT = OUT.filter(o => (o.date||'') >= from); }
    if(to) { IN = IN.filter(i => (i.date||'') <= to); OUT = OUT.filter(o => (o.date||'') <= to); }

    // store for exports
    window._reportIn = IN;
    window._reportOut = OUT;

    const sumIn = IN.reduce((a,b)=>a+Number(b.total||0),0);
    const sumInPaid = IN.reduce((a,b)=>a+Number(b.paid||0),0);
    const sumOut = OUT.reduce((a,b)=>a+Number(b.total||0),0);
    const sumOutPaid = OUT.reduce((a,b)=>a+Number(b.paid||0),0);

    statsBox.innerHTML = `<div class="p-2">
      <div><b>IN Total:</b> ‚Çπ${fmt(sumIn)} &nbsp; <b>Paid:</b> ‚Çπ${fmt(sumInPaid)} &nbsp; <b>Bal:</b> ‚Çπ${fmt(sumIn - sumInPaid)}</div>
      <div class="mt-2"><b>OUT Total:</b> ‚Çπ${fmt(sumOut)} &nbsp; <b>Paid:</b> ‚Çπ${fmt(sumOutPaid)} &nbsp; <b>Bal:</b> ‚Çπ${fmt(sumOut - sumOutPaid)}</div>
    </div>`;

  }catch(e){ console.error(e); statsBox.innerHTML = '<div class="text-red-500">‡§≤‡•ã‡§° ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä</div>'; }
}
filterName.addEventListener('input', ()=> debounce(loadReports,300));
filterFrom.addEventListener('change', loadReports);
filterTo.addEventListener('change', loadReports);
window.loadReports = loadReports;

/* ------------------- PDF Export ------------------- */
exportPdfBtn.addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  let y = 40;
  doc.setFontSize(16);
  doc.text("Inventory Report", 40, y); y+=24;
  doc.setFontSize(11);

  const rows = [...(window._reportIn||[]).map(r=>({type:'IN',...r})), ...(window._reportOut||[]).map(r=>({type:'OUT',...r}))];
  if(rows.length===0) return toast('‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∞‡§ø‡§ï‡§æ‡§Æ‡•Ä ‡§Ü‡§π‡•á ‚Äî ‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ.');

  rows.forEach(r => {
    const line = `${r.type} | ${r.date || ''} | ${r.from || r.to || ''} | ‚Çπ${fmt(r.total)} | Paid ‚Çπ${fmt(r.paid)} | Bal ‚Çπ${fmt(r.balance)}`;
    doc.text(line, 40, y); y += 14;
    if(y > 760){ doc.addPage(); y = 40; }
  });

  doc.save(`Report_${Date.now()}.pdf`);
});

/* ------------------- Excel Export ------------------- */
exportXlsxBtn.addEventListener('click', ()=>{
  const wb = XLSX.utils.book_new();
  const rows = [["Type","Date","Name","Total","Paid","Balance","PayType","FileURL"]];
  (window._reportIn||[]).forEach(i => rows.push(["IN", i.date||'', i.from||'', i.total||0, i.paid||0, i.balance||0, i.payType||'', i.fileURL||'']));
  (window._reportOut||[]).forEach(i => rows.push(["OUT", i.date||'', i.to||'', i.total||0, i.paid||0, i.balance||0, i.payType||'', i.fileURL||'']));
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "Report");
  XLSX.writeFile(wb, `Report_${Date.now()}.xlsx`);
});

/* ------------------- Backup / Restore ------------------- */
backupBtn.addEventListener('click', async ()=>{
  try{
    const inSnap = await db.collection('in_entries').get();
    const outSnap = await db.collection('out_entries').get();
    const data = { backupDate: new Date().toISOString(), in: inSnap.docs.map(d=>({id:d.id,...d.data()})), out: outSnap.docs.map(d=>({id:d.id,...d.data()})) };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `InventoryBackup_${Date.now()}.json`; a.click();
    toast('Backup ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ù‡§æ‡§≤‡§æ');
  }catch(e){ console.error(e); toast('Backup error'); }
});

restoreBtn.addEventListener('click', ()=> restoreFileInput.click());
restoreFileInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const json = JSON.parse(txt);
    if(!json.in || !json.out) return toast('Invalid backup file');
    if(!confirm('Restore ‡§ï‡•á‡§≤‡•ç‡§Ø‡§æ‡§®‡•á ‡§°‡•á‡§ü‡§æ ‡§™‡§∞‡§§ ‡§≠‡§∞‡§≤‡§æ ‡§ú‡§æ‡§à‡§≤. ‡§ö‡§æ‡§≤‡•Ç ‡§†‡•á‡§µ‡§æ‡§Ø‡§ö‡•á?')) return;
    for(const it of json.in){ await db.collection('in_entries').doc(it.id).set(it); }
    for(const it of json.out){ await db.collection('out_entries').doc(it.id).set(it); }
    toast('Restore ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ù‡§æ‡§≤‡•á');
    loadRecent(); loadReports();
  }catch(e){ console.error(e); toast('Restore error'); }
});

/* ------------------- Daily PDF ------------------- */
dailyPdfBtn.addEventListener('click', async ()=>{
  try{
    const today = new Date().toISOString().slice(0,10);
    filterFrom.value = today; filterTo.value = today;
    await loadReports();
    // reuse export pdf
    exportPdfBtn.click();
  }catch(e){ console.error(e); toast('Daily PDF error'); }
});

/* ------------------- Delete helpers above used ------------------- */

/* ------------------- Utilities ------------------- */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function debounce(fn, t){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a), t||300); }; }

/* ------------------- Init defaults ------------------- */
(function init(){
  const today = new Date().toISOString().slice(0,10);
  inDate.value = today; outDate.value = today;
  inPayType.value = 'Cash'; outPayType.value = 'Cash';
  // ensure reports array present
  window._reportIn = []; window._reportOut = [];
  loadRecent();
  loadReports();
})();
</script>
</body>
</html>
