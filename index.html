<!doctype html>
<html lang="mr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>рд╕рд╛рдорд╛рди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди тАУ Inventory</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    body { font-family: sans-serif; }
    .card { border-radius: 12px; box-shadow: 0 4px 14px rgba(0,0,0,0.1); }
    .big { font-size: 1.1rem; font-weight: 600; }
    .small { font-size: .9rem; }
  </style>
</head>

<body class="bg-amber-50 p-4">
<div class="max-w-xl mx-auto">

  <h1 class="text-2xl font-bold text-center text-amber-700 mb-4">ЁЯУж рд╕рд╛рдорд╛рди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди</h1>

  <!-- LOGIN BOX -->
  <div class="card bg-white p-4 mb-4" id="loginBox">
    <label class="big">рдлреЛрди рдирдВрдмрд░</label>
    <input id="phone" class="w-full p-3 border rounded mb-2 text-lg"
           placeholder="7020970727">

    <button id="sendOtp" class="w-full py-3 bg-amber-600 text-white rounded big mb-2">
      OTP рдкрд╛рдард╡рд╛
    </button>

    <div id="recaptcha-container"></div>

    <div id="otpArea" class="hidden">
      <input id="otp" class="w-full p-3 border rounded mt-3 text-lg" placeholder="OTP">
      <button id="verifyOtp" class="w-full py-3 mt-2 bg-green-600 text-white rounded big">
        рдкреБрд╖реНрдЯреА рдХрд░рд╛
      </button>
    </div>
  </div>

  <!-- USER BOX -->
  <div class="card bg-white p-4 mb-4 hidden" id="userBox">
    <div class="font-bold" id="userPhone"></div>
    <div class="text-sm text-gray-600" id="roleTxt"></div>
    <button id="logout" class="mt-3 px-3 py-2 bg-gray-200 rounded">Logout</button>
  </div>

  <!-- TABS -->
  <div class="flex gap-2 mb-3 hidden" id="tabs">
    <button id="tabIn" class="flex-1 py-3 bg-amber-600 text-white rounded big">IN</button>
    <button id="tabOut" class="flex-1 py-3 bg-white rounded big">OUT</button>
    <button id="tabReport" class="flex-1 py-3 bg-white rounded big">рд░рд┐рдкреЛрд░реНрдЯ</button>
  </div>

  <!-- IN PANEL -->
  <div id="panelIn" class="card bg-white p-4 mb-4 hidden">

    <h2 class="big mb-2">IN тАФ рд╕рд╛рдорд╛рди рдШреЗрддрд▓реЗ</h2>

    <input id="inDate" type="date" class="w-full p-3 border rounded mb-2">

    <input id="inFrom" placeholder="рдХреЛрдгрд╛рдХрдбреВрди" class="w-full p-3 border rounded mb-2">

    <div class="grid grid-cols-2 gap-2">
      <input id="inTotal" placeholder="рдПрдХреВрдг (тВ╣)" class="p-3 border rounded">
      <input id="inPaid" placeholder="рднрд░рд▓реЗ (тВ╣)" class="p-3 border rounded">
    </div>

    <select id="inType" class="w-full p-3 border rounded mt-2 mb-2">
      <option>Cash</option>
      <option>Online</option>
      <option>Baki</option>
    </select>

    <input id="inFile" type="file" class="mb-3">

    <button id="saveIn" class="w-full py-3 bg-amber-600 text-white rounded big">рдЬрддрди рдХрд░рд╛</button>

    <div id="recentIn" class="mt-3 text-sm"></div>
  </div>

  <!-- OUT PANEL -->
  <div id="panelOut" class="card bg-white p-4 mb-4 hidden">

    <h2 class="big mb-2">OUT тАФ рд╕рд╛рдорд╛рди рджрд┐рд▓реЗ</h2>

    <input id="outDate" type="date" class="w-full p-3 border rounded mb-2">

    <input id="outTo" placeholder="рдХреЛрдгрд╛рд▓рд╛" class="w-full p-3 border rounded mb-2">

    <div class="grid grid-cols-2 gap-2">
      <input id="outTotal" placeholder="рдПрдХреВрдг (тВ╣)" class="p-3 border rounded">
      <input id="outPaid" placeholder="рднрд░рд▓реЗ (тВ╣)" class="p-3 border rounded">
    </div>

    <select id="outType" class="w-full p-3 border rounded mt-2 mb-2">
      <option>Cash</option>
      <option>Online</option>
      <option>Baki</option>
    </select>

    <input id="outFile" type="file" class="mb-3">

    <button id="saveOut" class="w-full py-3 bg-blue-600 text-white rounded big">рдЬрддрди рдХрд░рд╛</button>

    <div id="recentOut" class="mt-3 text-sm"></div>
  </div>

  <!-- REPORT PANEL -->
  <div id="panelReport" class="card bg-white p-4 mb-4 hidden">

    <h2 class="big mb-3">ЁЯУК рд░рд┐рдкреЛрд░реНрдЯ</h2>

    <input id="searchName" placeholder="рдирд╛рд╡рд╛рдиреЗ рд╢реЛрдзрд╛" class="w-full p-3 border rounded mb-2">

    <label class="small">рддрд╛рд░реАрдЦ рдкрд╛рд╕реВрди</label>
    <input id="fromDate" type="date" class="w-full p-3 border rounded mb-2">

    <label class="small">рддрд╛рд░реАрдЦ рдкрд░реНрдпрдВрдд</label>
    <input id="toDate" type="date" class="w-full p-3 border rounded mb-3">

    <button id="loadReport" class="w-full py-3 bg-green-600 text-white rounded big">рд░рд┐рдкреЛрд░реНрдЯ рдкрд╛рд╣рд╛</button>

    <div id="reportData" class="mt-3 text-sm"></div>
  </div>

</div> <!-- container end -->

<!-- APP LOGIC -->
<script>

/* ----------------------------- Firebase Init ----------------------------- */
firebase.initializeApp({
  apiKey: "AIzaSyA3PdBavWlcE3w3QjgyOykv2jkAuFcUWbY",
  authDomain: "product-buy-sell.firebaseapp.com",
  projectId: "product-buy-sell",
  storageBucket: "product-buy-sell.firebasestorage.app",
  messagingSenderId: "815213852798",
  appId: "1:815213852798:web:d347aec03aa3a46ba3802f"
});
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ----------------------------- OTP SEND ----------------------------- */
document.getElementById("sendOtp").onclick = async ()=>{
  let mob = document.getElementById("phone").value.trim();
  if(!/^[0-9]{10}$/.test(mob)) return alert("рдпреЛрдЧреНрдп рдирдВрдмрд░ рдЯрд╛рдХрд╛");

  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier("recaptcha-container",{size:"invisible"});

  try{
    window.confirmObj = await auth.signInWithPhoneNumber("+91"+mob, window.recaptchaVerifier);
    document.getElementById("otpArea").classList.remove("hidden");
    alert("OTP рдкрд╛рдард╡рд▓рд╛");
  }catch(e){ alert(e.message); }
};

/* ----------------------------- OTP VERIFY ----------------------------- */
document.getElementById("verifyOtp").onclick = async ()=>{
  let code = document.getElementById("otp").value.trim();
  try{
    const user = await window.confirmObj.confirm(code);
    onLogin(user.user);
  }catch(e){ alert("OTP рдЪреБрдХреАрдЪрд╛"); }
};

/* ----------------------------- LOGIN SUCCESS ----------------------------- */
function onLogin(user){
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("userBox").classList.remove("hidden");

  document.getElementById("userPhone").innerText = user.phoneNumber;

  let admin = user.phoneNumber === "+917020970727";
  document.getElementById("roleTxt").innerText = admin ? "Admin рдкреНрд░рд╡реЗрд╢" : "User рдкреНрд░рд╡реЗрд╢";

  document.getElementById("tabs").classList.remove("hidden");

  showTab("in");

  loadRecentIn();
  loadRecentOut();
}

/* ----------------------------- Logout ----------------------------- */
document.getElementById("logout").onclick = ()=> auth.signOut().then(()=>location.reload());

/* ----------------------------- TABS ----------------------------- */
function showTab(t){
  const pIn = document.getElementById("panelIn");
  const pOut = document.getElementById("panelOut");
  const pRep = document.getElementById("panelReport");

  pIn.classList.add("hidden");
  pOut.classList.add("hidden");
  pRep.classList.add("hidden");

  if(t==="in") pIn.classList.remove("hidden");
  if(t==="out") pOut.classList.remove("hidden");
  if(t==="rep") pRep.classList.remove("hidden");
}

document.getElementById("tabIn").onclick = ()=>showTab("in");
document.getElementById("tabOut").onclick = ()=>showTab("out");
document.getElementById("tabReport").onclick = ()=>showTab("rep");

/* ----------------------------- FILE UPLOAD ----------------------------- */
async function uploadFile(f, folder){
  if(!f) return null;
  let ref = storage.ref(folder + "/" + Date.now()+"_"+f.name);
  let snap = await ref.put(f);
  return await snap.ref.getDownloadURL();
}

/* ----------------------------- SAVE IN ----------------------------- */
document.getElementById("saveIn").onclick = async ()=>{
  let d = document.getElementById("inDate").value;
  let from = document.getElementById("inFrom").value.trim();
  let total = Number(document.getElementById("inTotal").value);
  let paid = Number(document.getElementById("inPaid").value);
  let type = document.getElementById("inType").value;
  let file = document.getElementById("inFile").files[0];

  if(!from || total<=0) return alert("рдкреВрд░реНрдг рдорд╛рд╣рд┐рддреА рджреНрдпрд╛");

  let url = await uploadFile(file,"in");

  await db.collection("in_entries").add({
    date:d, from, total, paid,
    balance: total-paid,
    paymentType:type,
    fileUrl:url||null,
    created:Date.now()
  });

  alert("IN рдЬрддрди рдЭрд╛рд▓реЗ");
  loadRecentIn();
};

/* ----------------------------- LOAD IN ----------------------------- */
async function loadRecentIn(){
  let box = document.getElementById("recentIn");
  box.innerHTML = "рд▓реЛрдбтАж";

  let snap = await db.collection("in_entries").orderBy("created","desc").limit(10).get();

  box.innerHTML = "";
  snap.forEach(doc=>{
    let x = doc.data();
    box.innerHTML += `
      <div class="p-2 border rounded mb-1">
        <b>${x.from}</b> тАФ ${x.date}<br>
        Total тВ╣${x.total} | Paid тВ╣${x.paid} | Bal тВ╣${x.balance}<br>
        ${x.fileUrl ? `<a href="${x.fileUrl}" target="_blank" class="text-blue-600 text-xs">рдмрд┐рд▓</a>` : ""}
      </div>`;
  });
}

/* ----------------------------- SAVE OUT ----------------------------- */
document.getElementById("saveOut").onclick = async ()=>{
  let d = document.getElementById("outDate").value;
  let to = document.getElementById("outTo").value.trim();
  let total = Number(document.getElementById("outTotal").value);
  let paid = Number(document.getElementById("outPaid").value);
  let type = document.getElementById("outType").value;
  let file = document.getElementById("outFile").files[0];

  if(!to || total<=0) return alert("рдкреВрд░реНрдг рдорд╛рд╣рд┐рддреА рджреНрдпрд╛");

  let url = await uploadFile(file,"out");

  await db.collection("out_entries").add({
    date:d, to, total, paid,
    balance: total-paid,
    paymentType:type,
    fileUrl:url||null,
    created:Date.now()
  });

  alert("OUT рдЬрддрди рдЭрд╛рд▓реЗ");
  loadRecentOut();
};

/* ----------------------------- LOAD OUT ----------------------------- */
async function loadRecentOut(){
  let box = document.getElementById("recentOut");
  box.innerHTML = "рд▓реЛрдбтАж";

  let snap = await db.collection("out_entries").orderBy("created","desc").limit(10).get();
  box.innerHTML="";

  snap.forEach(doc=>{
    let x = doc.data();
    box.innerHTML += `
      <div class="p-2 border rounded mb-1">
        <b>${x.to}</b> тАФ ${x.date}<br>
        тВ╣${x.total} | Paid тВ╣${x.paid} | Bal тВ╣${x.balance}<br>
        ${x.fileUrl ? `<a href="${x.fileUrl}" target="_blank" class="text-blue-600 text-xs">рдкреНрд░реВрдл</a>` : ""}
      </div>`;
  });
}

/* ----------------------------- REPORT ----------------------------- */
document.getElementById("loadReport").onclick = async ()=>{
  let name = document.getElementById("searchName").value.trim().toLowerCase();
  let from = document.getElementById("fromDate").value;
  let to = document.getElementById("toDate").value;
  let box = document.getElementById("reportData");

  box.innerHTML = "рд▓реЛрдбтАж";

  let IN = await db.collection("in_entries").get();
  let OUT = await db.collection("out_entries").get();

  let list = [];

  IN.forEach(d=>{
    let x=d.data();
    list.push({type:"IN",name:x.from,date:x.date,total:x.total,paid:x.paid,bal:x.balance});
  });

  OUT.forEach(d=>{
    let x=d.data();
    list.push({type:"OUT",name:x.to,date:x.date,total:x.total,paid:x.paid,bal:x.balance});
  });

  list = list.filter(x=>{
    if(name && !x.name.toLowerCase().includes(name)) return false;
    if(from && x.date < from) return false;
    if(to && x.date > to) return false;
    return true;
  });

  box.innerHTML="";
  if(!list.length){ box.innerHTML="рдХрд╛рд╣реА рдиреЛрдВрджреА рдирд╛рд╣реАрдд"; return; }

  list.forEach(x=>{
    box.innerHTML += `
      <div class="p-2 border rounded mb-1">
        <b>${x.type}</b> тАФ ${x.name}<br>
        ${x.date} | тВ╣${x.total} | Paid тВ╣${x.paid} | Bal тВ╣${x.bal}
      </div>`;
  });
};

</script>
</body>
</html>
