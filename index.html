<!doctype html>
<html lang="mr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡§∏‡§æ‡§Æ‡§æ‡§® ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‚Äî Inventory App (Marathi)</title>

  <!-- Tailwind (fast, mobile friendly) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (compat libraries for simple single-file use) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* Larger, bold Marathi-friendly UI tweaks (D style) */
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .big { font-size: 1.05rem; font-weight:600; }
    .small { font-size: .9rem; }
    .card { border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    /* Make buttons touch-friendly */
    button { touch-action: manipulation; }
  </style>
</head>

<body class="bg-amber-50 min-h-screen p-4">
  <div class="max-w-xl mx-auto">
    <header class="mb-4 text-center">
      <div class="inline-flex items-center gap-2">
        <div class="bg-amber-600 text-white rounded p-2 shadow"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M3 7h18M3 12h18M3 17h18"/></svg></div>
        <h1 class="text-2xl font-extrabold text-amber-700">‡§∏‡§æ‡§Æ‡§æ‡§® ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®</h1>
      </div>
      <p class="text-sm text-gray-700 mt-1">‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Æ‡§∞‡§æ‡§†‡•Ä UI ‚Ä¢ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤-‡§´‡•ç‡§∞‡•á‡§Ç‡§°‡§≤‡•Ä ‚Ä¢ OTP ‡§≤‡•â‡§ó‡§ø‡§®</p>
    </header>

    <!-- AUTH CARD -->
    <div id="authCard" class="card bg-white p-4 mb-4">
      <div id="authLoggedOut">
        <label class="big">‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ (10 ‡§Ö‡§Ç‡§ï)</label>
        <div class="flex gap-2 mt-2">
          <input id="phoneInput" class="flex-1 p-3 border rounded text-lg" placeholder="‡§â‡§¶‡§æ. 7020970727" inputmode="numeric"/>
          <button id="sendOtpBtn" class="px-4 py-3 bg-amber-600 text-white rounded big">OTP ‡§™‡§æ‡§†‡§µ‡§æ</button>
        </div>
        <div id="recaptcha-container" class="mt-3"></div>
        <div id="otpRow" class="mt-3 hidden">
          <input id="otpInput" class="p-3 border rounded w-2/3 text-lg" placeholder="OTP ‡§ï‡•ã‡§°" inputmode="numeric"/>
          <button id="verifyOtpBtn" class="px-3 py-3 ml-2 bg-green-600 text-white rounded big">‡§™‡•Å‡§∑‡•ç‡§ü‡•Ä ‡§ï‡§∞‡§æ</button>
        </div>
      </div>

      <div id="authLoggedIn" class="hidden">
        <div class="flex justify-between items-center">
          <div>
            <div id="userPhone" class="font-semibold big"></div>
            <div id="userRole" class="text-sm text-gray-600 mt-1"></div>
          </div>
          <div>
            <button id="logoutBtn" class="px-3 py-2 bg-gray-200 rounded">Logout</button>
          </div>
        </div>
      </div>
      <div id="authMsg" class="mt-3 text-sm text-gray-500"></div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2 mb-3">
      <button id="tabIn" class="flex-1 py-3 rounded bg-amber-600 text-white big">üì• ‡§ò‡•á‡§£‡•á (IN)</button>
      <button id="tabOut" class="flex-1 py-3 rounded bg-white big">üì§ ‡§¶‡•á‡§£‡•á (OUT)</button>
      <button id="tabReports" class="flex-1 py-3 rounded bg-white big">üìä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</button>
    </div>

    <!-- IN Panel -->
    <section id="panelIn" class="card bg-white p-4 mb-4">
      <h2 class="font-bold big mb-2">IN ‚Äî ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ò‡•á‡§§‡§≤‡•á</h2>
      <form id="inForm" class="space-y-3">
        <div>
          <label class="small">‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
          <input id="inDate" type="date" class="w-full p-3 border rounded" />
        </div>
        <div>
          <label class="small">‡§ï‡•ã‡§£‡§æ‡§ï‡§°‡•Ç‡§®</label>
          <input id="inFrom" class="w-full p-3 border rounded" placeholder="‡§™‡•Å‡§∞‡§µ‡§†‡§æ‡§¶‡§æ‡§∞‡§æ‡§ö‡•á ‡§®‡§æ‡§µ" />
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="small">‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</label>
            <input id="inTotal" class="w-full p-3 border rounded" inputmode="numeric" />
          </div>
          <div>
            <label class="small">‡§≠‡§∞‡§≤‡•á (Paid ‚Çπ)</label>
            <input id="inPaid" class="w-full p-3 border rounded" inputmode="numeric" />
          </div>
        </div>
        <div>
          <label class="small">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</label>
          <select id="inPayType" class="w-full p-3 border rounded">
            <option>Cash</option><option>Online</option><option>Baki</option>
          </select>
        </div>
        <div>
          <label class="small">‡§¨‡§ø‡§≤ / ‡§´‡•ã‡§ü‡•ã (‡§ê‡§ö‡•ç‡§õ‡§ø‡§ï)</label>
          <input id="inFile" type="file" accept="image/*,application/pdf" class="w-full" />
        </div>
        <div class="flex gap-2">
          <button class="flex-1 py-3 bg-amber-600 text-white rounded big" type="submit">IN ‡§ú‡§§‡§® ‡§ï‡§∞‡§æ</button>
          <button id="inClear" type="button" class="flex-1 py-3 bg-gray-100 rounded">‡§ï‡•ç‡§≤‡§ø‡§Ö‡§∞</button>
        </div>
      </form>

      <div class="mt-4">
        <div class="font-semibold">‡§Ö‡§≤‡•Ä‡§ï‡§°‡•Ä‡§≤ IN ‡§®‡•ã‡§Ç‡§¶‡•Ä</div>
        <div id="recentIn" class="mt-2 space-y-2 small text-gray-700"></div>
      </div>
    </section>

    <!-- OUT Panel -->
    <section id="panelOut" class="card bg-white p-4 mb-4 hidden">
      <h2 class="font-bold big mb-2">OUT ‚Äî ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§¶‡§ø‡§≤‡•á</h2>
      <form id="outForm" class="space-y-3">
        <div>
          <label class="small">‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
          <input id="outDate" type="date" class="w-full p-3 border rounded" />
        </div>
        <div>
          <label class="small">‡§ï‡•ã‡§£‡§æ‡§≤‡§æ</label>
          <input id="outTo" class="w-full p-3 border rounded" placeholder="‡§ó‡•ç‡§∞‡§æ‡§π‡§ï‡§æ‡§ö‡•á ‡§®‡§æ‡§µ" />
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="small">‡§è‡§ï‡•Ç‡§£ ‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</label>
            <input id="outTotal" class="w-full p-3 border rounded" inputmode="numeric" />
          </div>
          <div>
            <label class="small">‡§≠‡§∞‡§≤‡•á (Paid ‚Çπ)</label>
            <input id="outPaid" class="w-full p-3 border rounded" inputmode="numeric" />
          </div>
        </div>
        <div>
          <label class="small">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</label>
          <select id="outPayType" class="w-full p-3 border rounded">
            <option>Cash</option><option>Online</option><option>Baki</option>
          </select>
        </div>
        <div>
          <label class="small">‡§™‡•ç‡§∞‡•Ç‡§´ (‡§´‡•ã‡§ü‡•ã / PDF)</label>
          <input id="outFile" type="file" accept="image/*,application/pdf" class="w-full" />
        </div>
        <div class="flex gap-2">
          <button class="flex-1 py-3 bg-blue-600 text-white rounded big" type="submit">OUT ‡§ú‡§§‡§® ‡§ï‡§∞‡§æ</button>
          <button id="outClear" type="button" class="flex-1 py-3 bg-gray-100 rounded">‡§ï‡•ç‡§≤‡§ø‡§Ö‡§∞</button>
        </div>
      </form>

      <div class="mt-4">
        <div class="font-semibold">‡§Ö‡§≤‡•Ä‡§ï‡§°‡•Ä‡§≤ OUT ‡§®‡•ã‡§Ç‡§¶‡•Ä</div>
        <div id="recentOut" class="mt-2 space-y-2 small text-gray-700"></div>
      </div>
    </section>

    <!-- Reports Panel -->
    <section id="panelReports" class="card bg-white p-4 mb-6 hidden">
      <h2 class="font-bold big mb-2">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡•ç‡§∏</h2>
      <div class="grid grid-cols-2 gap-2 mb-3">
        <input id="filterFrom" type="date" class="p-3 border rounded" />
        <input id="filterTo" type="date" class="p-3 border rounded" />
      </div>
      <input id="filterName" class="w-full p-3 border rounded mb-3" placeholder="‡§®‡§æ‡§µ‡§æ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§∂‡•ã‡§ß‡§æ (‡§ï‡•ã‡§£‡§æ‡§ï‡§°‡•Ç‡§® / ‡§ï‡•ã‡§£‡§æ‡§≤‡§æ)" />

      <div id="summaryBox" class="grid grid-cols-2 gap-2 mb-3 small">
        <div class="p-3 bg-amber-50 rounded">
          <div class="text-xs text-gray-600">IN (‡§è‡§ï‡•Ç‡§£)</div>
          <div id="inTotalSum" class="font-semibold">‚Çπ0</div>
          <div class="text-xs text-gray-500">Paid ‚Çπ0 | Balance ‚Çπ0</div>
        </div>
        <div class="p-3 bg-amber-50 rounded">
          <div class="text-xs text-gray-600">OUT (‡§è‡§ï‡•Ç‡§£)</div>
          <div id="outTotalSum" class="font-semibold">‚Çπ0</div>
          <div class="text-xs text-gray-500">Paid ‚Çπ0 | Balance ‚Çπ0</div>
        </div>
      </div>

      <div id="paymentBreak" class="mb-3 small"></div>
      <div id="personBalances" class="mb-3 small"></div>

      <div class="flex gap-2">
        <button id="exportCsvBtn" class="flex-1 py-3 bg-green-600 text-white rounded big">CSV ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
        <button id="exportPdfBtn" class="flex-1 py-3 bg-gray-100 rounded big">PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-600 mt-4">
      ¬© Inventory App ‚Äî ‡§Æ‡§∞‡§æ‡§†‡•Ä ‚Ä¢ Admin: 7020970727
    </footer>
  </div>

  <!-- App Script -->
  <script>
    /***** Firebase config (user provided) *****/
    const firebaseConfig = {
      apiKey: "AIzaSyA3PdBavWlcE3w3QjgyOykv2jkAuFcUWbY",
      authDomain: "product-buy-sell.firebaseapp.com",
      projectId: "product-buy-sell",
      storageBucket: "product-buy-sell.firebasestorage.app",
      messagingSenderId: "815213852798",
      appId: "1:815213852798:web:d347aec03aa3a46ba3802f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    /***** UI Elements *****/
    const phoneInput = document.getElementById('phoneInput');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const otpRow = document.getElementById('otpRow');
    const otpInput = document.getElementById('otpInput');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const authLoggedOut = document.getElementById('authLoggedOut');
    const authLoggedIn = document.getElementById('authLoggedIn');
    const userPhoneEl = document.getElementById('userPhone');
    const userRoleEl = document.getElementById('userRole');
    const logoutBtn = document.getElementById('logoutBtn');

    const tabIn = document.getElementById('tabIn'), tabOut = document.getElementById('tabOut'), tabReports = document.getElementById('tabReports');
    const panelIn = document.getElementById('panelIn'), panelOut = document.getElementById('panelOut'), panelReports = document.getElementById('panelReports');

    // IN elements
    const inForm = document.getElementById('inForm');
    const inDate = document.getElementById('inDate'), inFrom = document.getElementById('inFrom'), inTotal = document.getElementById('inTotal'), inPaid = document.getElementById('inPaid'), inPayType = document.getElementById('inPayType'), inFile = document.getElementById('inFile');
    const recentIn = document.getElementById('recentIn');

    // OUT elements
    const outForm = document.getElementById('outForm');
    const outDate = document.getElementById('outDate'), outTo = document.getElementById('outTo'), outTotal = document.getElementById('outTotal'), outPaid = document.getElementById('outPaid'), outPayType = document.getElementById('outPayType'), outFile = document.getElementById('outFile');
    const recentOut = document.getElementById('recentOut');

    // Reports
    const filterFrom = document.getElementById('filterFrom'), filterTo = document.getElementById('filterTo'), filterName = document.getElementById('filterName');
    const inTotalSum = document.getElementById('inTotalSum'), outTotalSum = document.getElementById('outTotalSum'), paymentBreak = document.getElementById('paymentBreak'), personBalances = document.getElementById('personBalances');
    const exportCsvBtn = document.getElementById('exportCsvBtn'), exportPdfBtn = document.getElementById('exportPdfBtn');

    /***** Helpers *****/
    function toast(txt){ alert(txt); }
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function setActiveTab(tabName){
      if(tabName==='in'){ panelIn.classList.remove('hidden'); panelOut.classList.add('hidden'); panelReports.classList.add('hidden'); tabIn.classList.add('bg-amber-600','text-white'); tabOut.classList.remove('bg-blue-600'); tabReports.classList.remove('bg-green-600'); }
      if(tabName==='out'){ panelOut.classList.remove('hidden'); panelIn.classList.add('hidden'); panelReports.classList.add('hidden'); tabOut.classList.add('bg-blue-600','text-white'); tabIn.classList.remove('bg-amber-600'); tabReports.classList.remove('bg-green-600'); }
      if(tabName==='reports'){ panelReports.classList.remove('hidden'); panelIn.classList.add('hidden'); panelOut.classList.add('hidden'); tabReports.classList.add('bg-green-600','text-white'); tabIn.classList.remove('bg-amber-600'); tabOut.classList.remove('bg-blue-600'); loadReports(); }
    }

    tabIn.onclick = ()=> setActiveTab('in');
    tabOut.onclick = ()=> setActiveTab('out');
    tabReports.onclick = ()=> setActiveTab('reports');

    // initial
    setActiveTab('in');

    /***** Auth (Phone OTP) *****/
    function setupRecaptcha(){
      if(window.recaptchaVerifier) return;
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {size:'invisible'});
      window.recaptchaVerifier.render();
    }

    sendOtpBtn.addEventListener('click', async ()=>{
      const num = phoneInput.value.trim();
      if(!/^[0-9]{10}$/.test(num)){ toast('‡§ï‡•É‡§™‡§Ø‡§æ 10 ‡§Ö‡§Ç‡§ï‡•Ä ‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡•ç‡§Ø‡§æ'); return; }
      setupRecaptcha();
      const phoneNumber = '+91' + num;
      try {
        const confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier);
        window.confirmationResult = confirmationResult;
        show(otpRow);
        toast('OTP ‡§™‡§æ‡§†‡§µ‡§≤‡§æ ‡§ó‡•á‡§≤‡§æ ‡§Ü‡§π‡•á. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§™‡§æ‡§∏‡§æ.');
      } catch(e){
        console.error(e);
        toast('OTP ‡§™‡§æ‡§†‡§µ‡§§‡§æ‡§®‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ' + (e.message || e));
      }
    });

    verifyOtpBtn.addEventListener('click', async ()=>{
      const code = otpInput.value.trim();
      if(!code){ toast('‡§ï‡•É‡§™‡§Ø‡§æ OTP ‡§ü‡§æ‡§ï‡§æ'); return; }
      try {
        const result = await window.confirmationResult.confirm(code);
        const user = result.user;
        onLogin(user);
      } catch(e){
        console.error(e);
        toast('OTP ‡§™‡§°‡§§‡§æ‡§≥‡§£‡•Ä ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä: ' + (e.message || e));
      }
    });

    logoutBtn.addEventListener('click', ()=> auth.signOut());

    auth.onAuthStateChanged(async (user)=>{
      if(user) onLogin(user); else onLogout();
    });

    async function onLogin(user){
      authLoggedOut.style.display = 'none';
      authLoggedIn.style.display = 'block';
      userPhoneEl.textContent = user.phoneNumber || '';
      // check admin doc in Firestore
      try {
        const docRef = db.collection('admins').doc(user.phoneNumber);
        const docSnap = await docRef.get();
        const isAdmin = docSnap.exists;
        userRoleEl.textContent = isAdmin ? 'Role: Admin' : 'Role: User';
        userRoleEl.style.color = isAdmin ? 'green' : 'gray';
        enableForms(true);
        loadRecent();
      } catch(e){ console.error(e); toast('Admin Check error'); enableForms(true); loadRecent(); }
    }

    function onLogout(){
      authLoggedOut.style.display = '';
      authLoggedIn.style.display = 'none';
      userPhoneEl.textContent = '';
      userRoleEl.textContent = '';
      enableForms(false);
    }

    function enableForms(v){
      // allow only auth buttons when not logged in
      const selectors = 'input,select,button';
      document.querySelectorAll(selectors).forEach(el=>{
        if(['sendOtpBtn','verifyOtpBtn'].includes(el.id)) return;
        if(el.id==='logoutBtn') return;
        el.disabled = !v;
      });
    }
    enableForms(false);

    /***** File upload helper *****/
    async function uploadFile(file, folder){
      if(!file) return null;
      const path = `${folder}/${Date.now()}_${file.name}`;
      const ref = storage.ref().child(path);
      const snap = await ref.put(file);
      return await snap.ref.getDownloadURL();
    }

    /***** IN submit *****/
    inForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const date = inDate.value || new Date().toISOString().slice(0,10);
      const from = inFrom.value.trim();
      const total = Number(inTotal.value) || 0;
      const paid = Number(inPaid.value) || 0;
      const payType = inPayType.value;
      const file = inFile.files[0];
      if(!from || total<=0){ toast('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§≠‡§∞‡§æ'); return; }
      try {
        const fileUrl = await uploadFile(file,'in');
        await db.collection('in_entries').add({ date, from, total, paid, balance: total-paid, paymentType: payType, fileUrl: fileUrl||null, createdAt: Date.now() });
        toast('IN ‡§®‡•ã‡§Ç‡§¶ ‡§ú‡§§‡§® ‡§ù‡§æ‡§≤‡•Ä');
        inForm.reset();
        loadRecent();
      } catch(e){ console.error(e); toast('IN ‡§ú‡§§‡§® ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä'); }
    });
    document.getElementById('inClear').addEventListener('click', ()=> inForm.reset());

    /***** OUT submit *****/
    outForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const date = outDate.value || new Date().toISOString().slice(0,10);
      const to = outTo.value.trim();
      const total = Number(outTotal.value) || 0;
      const paid = Number(outPaid.value) || 0;
      const payType = outPayType.value;
      const file = outFile.files[0];
      if(!to || total<=0){ toast('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§≠‡§∞‡§æ'); return; }
      try {
        const fileUrl = await uploadFile(file,'out');
        await db.collection('out_entries').add({ date, to, total, paid, balance: total-paid, paymentType: payType, fileUrl: fileUrl||null, createdAt: Date.now() });
        toast('OUT ‡§®‡•ã‡§Ç‡§¶ ‡§ú‡§§‡§® ‡§ù‡§æ‡§≤‡•Ä');
        outForm.reset();
        loadRecent();
      } catch(e){ console.error(e); toast('OUT ‡§ú‡§§‡§® ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä'); }
    });
    document.getElementById('outClear').addEventListener('click', ()=> outForm.reset());

    /***** Load recent IN/OUT *****/
    async function loadRecent(){
      recentIn.innerHTML = '‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•ã‡§§...';
      recentOut.innerHTML = '‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•ã‡§§...';
      try {
        const inSnap = await db.collection('in_entries').orderBy('createdAt','desc').limit(8).get();
        const outSnap = await db.collection('out_entries').orderBy('createdAt','desc').limit(8).get();
        recentIn.innerHTML = ''; recentOut.innerHTML = '';
        inSnap.forEach(doc=> {
          const it = doc.data();
          const el = document.createElement('div');
          el.className = 'p-2 border rounded';
          el.innerHTML = `<div class="font-semibold">${escapeHtml(it.from)} ‚Äî ${escapeHtml(it.date)}</div>
            <div class="text-xs text-gray-600">Total ‚Çπ${it.total} | Paid ‚Çπ${it.paid} | Bal ‚Çπ${it.balance} | ${escapeHtml(it.paymentType)}</div>
            ${it.fileUrl?`<a class="text-xs text-blue-600" href="${it.fileUrl}" target="_blank">‡§¨‡§ø‡§≤ ‡§™‡§π‡§æ</a>`:''}`;
          recentIn.appendChild(el);
        });
        outSnap.forEach(doc=> {
          const it = doc.data();
          const el = document.createElement('div');
          el.className = 'p-2 border rounded';
          el.innerHTML = `<div class="font-semibold">${escapeHtml(it.to)} ‚Äî ${escapeHtml(it.date)}</div>
            <div class="text-xs text-gray-600">Total ‚Çπ${it.total} | Paid ‚Çπ${it.paid} | Bal ‚Çπ${it.balance} | ${escapeHtml(it.paymentType)}</div>
            ${it.fileUrl?`<a class="text-xs text-blue-600" href="${it.fileUrl}" target="_blank">‡§™‡•ç‡§∞‡•Ç‡§´ ‡§™‡§π‡§æ</a>`:''}`;
          recentOut.appendChild(el);
        });
      } catch(e){ console.error(e); recentIn.innerHTML='‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä'; recentOut.innerHTML='‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä'; }
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

    /***** Reports *****/
    async function loadReports(){
      try {
        const inSnap = await db.collection('in_entries').orderBy('date','desc').get();
        const outSnap = await db.collection('out_entries').orderBy('date','desc').get();
        const inList = inSnap.docs.map(d=>d.data());
        const outList = outSnap.docs.map(d=>d.data());

        // filters
        const from = filterFrom.value ? new Date(filterFrom.value) : null;
        const to = filterTo.value ? (function(){ let t=new Date(filterTo.value); t.setHours(23,59,59,999); return t; })() : null;
        const name = filterName.value.trim().toLowerCase();

        function keep(item, isIn){
          const dt = new Date(item.date);
          if(from && dt < from) return false;
          if(to && dt > to) return false;
          if(name){
            const n = (isIn?item.from:item.to||'').toLowerCase();
            if(!n.includes(name)) return false;
          }
          return true;
        }

        const fin = inList.filter(i=>keep(i,true));
        const fout = outList.filter(i=>keep(i,false));

        // totals
        const sum = arr => arr.reduce((s,a)=> s + (Number(a.total)||0), 0);
        const sumPaid = arr => arr.reduce((s,a)=> s + (Number(a.paid)||0), 0);
        const sumBal = arr => arr.reduce((s,a)=> s + (Number(a.balance)||0), 0);

        inTotalSum.textContent = `‚Çπ${sum(fin)}`;
        outTotalSum.textContent = `‚Çπ${sum(fout)}`;

        // payment breakdown
        function breakdown(arr){
          const map = {};
          arr.forEach(it=>{
            const k = it.paymentType || 'Cash';
            if(!map[k]) map[k] = { total:0, paid:0, balance:0, count:0 };
            map[k].total += Number(it.total)||0;
            map[k].paid += Number(it.paid)||0;
            map[k].balance += Number(it.balance)||0;
            map[k].count += 1;
          });
          return map;
        }
        const inBreak = breakdown(fin), outBreak = breakdown(fout);
        paymentBreak.innerHTML = '<div class="font-semibold mb-1">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü-‡§µ‡§æ‡§á‡§ú ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</div>';
        for(const k in inBreak) paymentBreak.innerHTML += `<div class="text-sm">IN ${k}: ‚Çπ${inBreak[k].total} (Paid ‚Çπ${inBreak[k].paid} | Bal ‚Çπ${inBreak[k].balance})</div>`;
        for(const k in outBreak) paymentBreak.innerHTML += `<div class="text-sm">OUT ${k}: ‚Çπ${outBreak[k].total} (Paid ‚Çπ${outBreak[k].paid} | Bal ‚Çπ${outBreak[k].balance})</div>`;

        // person-wise
        const map = {};
        fin.forEach(it=>{
          const name = it.from||'--';
          if(!map[name]) map[name] = { in_total:0, in_paid:0, in_bal:0, out_total:0, out_paid:0, out_bal:0 };
          map[name].in_total += Number(it.total)||0;
          map[name].in_paid += Number(it.paid)||0;
          map[name].in_bal += Number(it.balance)||0;
        });
        fout.forEach(it=>{
          const name = it.to||'--';
          if(!map[name]) map[name] = { in_total:0, in_paid:0, in_bal:0, out_total:0, out_paid:0, out_bal:0 };
          map[name].out_total += Number(it.total)||0;
          map[name].out_paid += Number(it.paid)||0;
          map[name].out_bal += Number(it.balance)||0;
        });

        personBalances.innerHTML = '<div class="font-semibold mb-1">‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡•Ä-‡§µ‡§æ‡§∞ ‡§¨‡•Ö‡§≤‡§®‡•ç‡§∏</div>';
        Object.keys(map).sort().forEach(n=>{
          const v = map[n];
          personBalances.innerHTML += `<div class="p-2 border rounded mb-2"><div class="font-semibold">${escapeHtml(n)}</div>
            <div class="text-xs text-gray-600">IN ‚Çπ${v.in_total} (Paid ${v.in_paid}) | OUT ‚Çπ${v.out_total} (Paid ${v.out_paid})</div>
            <div class="text-sm">IN Bal ‚Çπ${v.in_bal} | OUT Bal ‚Çπ${v.out_bal}</div></div>`;
        });

        // store for export
        window._reportIn = fin; window._reportOut = fout;

      } catch(e){ console.error(e); toast('‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä'); }
    }

    // update reports when filters change
    filterFrom.addEventListener('change', loadReports);
    filterTo.addEventListener('change', loadReports);
    filterName.addEventListener('input', debounce(loadReports,400));

    /***** CSV Export *****/
    exportCsvBtn.addEventListener('click', ()=>{
      const rows = [['Type','Date','Name','Total','Paid','Balance','PaymentType','FileURL']];
      (window._reportIn||[]).forEach(r=> rows.push(['IN', r.date, r.from, r.total, r.paid, r.balance, r.paymentType, r.fileUrl||'']));
      (window._reportOut||[]).forEach(r=> rows.push(['OUT', r.date, r.to, r.total, r.paid, r.balance, r.paymentType, r.fileUrl||'']));
      const csv = rows.map(r=> r.map(c=> `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `report_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
    });

    /***** PDF Export (simple) *****/
    exportPdfBtn.addEventListener('click', ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      doc.setFontSize(14); doc.text('Inventory Report', 40, 40);
      let y = 70;
      const drawList = (list, title)=>{
        doc.setFontSize(12); doc.text(title, 40, y); y += 18;
        list.forEach(i=>{
          const line = `${i.date} - ${i.from || i.to} - ‚Çπ${i.total} Paid:${i.paid} Bal:${i.balance}`;
          doc.setFontSize(10); doc.text(line, 40, y); y += 14;
          if(y > 760){ doc.addPage(); y = 40; }
        });
      };
      drawList(window._reportIn || [], 'IN Entries:');
      doc.addPage(); y = 40;
      drawList(window._reportOut || [], 'OUT Entries:');
      doc.save(`report_${Date.now()}.pdf`);
    });

    /***** Excel Export (SheetJS) - combined *****/
    function exportExcel(){
      const wb = XLSX.utils.book_new();
      const rows = [['Type','Date','Name','Total','Paid','Balance','PaymentType','FileURL']];
      (window._reportIn||[]).forEach(r=> rows.push(['IN', r.date, r.from, r.total, r.paid, r.balance, r.paymentType, r.fileUrl||'']));
      (window._reportOut||[]).forEach(r=> rows.push(['OUT', r.date, r.to, r.total, r.paid, r.balance, r.paymentType, r.fileUrl||'']));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, 'Report');
      XLSX.writeFile(wb, `report_${Date.now()}.xlsx`);
    }

    // optional quick export button via long-press on PDF button? keep simple: ctrl+click (not required)
    // provide small helper: long press on exportPdfBtn for Excel
    let longPressTimer = null;
    exportPdfBtn.addEventListener('touchstart', ()=> longPressTimer = setTimeout(()=> exportExcel(), 800));
    exportPdfBtn.addEventListener('touchend', ()=> clearTimeout(longPressTimer));
    exportPdfBtn.addEventListener('mousedown', ()=> longPressTimer = setTimeout(()=> exportExcel(), 800));
    exportPdfBtn.addEventListener('mouseup', ()=> clearTimeout(longPressTimer));

    /***** Utilities *****/
    function debounce(fn, t){
      let timer;
      return function(){ clearTimeout(timer); timer = setTimeout(()=> fn.apply(this, arguments), t); };
    }

    // initial load
    document.addEventListener('DOMContentLoaded', ()=> {
      // prefill dates to today
      const today = new Date().toISOString().slice(0,10);
      inDate.value = today; outDate.value = today; filterFrom.value = ''; filterTo.value = '';
      loadRecent();
    });

  </script>
</body>
</html>
