<!doctype html>
<html lang="mr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>рд╕рд╛рдорд╛рди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди</title>

<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family:sans-serif; }
.card { border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
</style>
</head>

<body class="bg-amber-50 p-4 min-h-screen">

<h1 class="text-center text-2xl font-bold text-amber-700 mb-4">
ЁЯУж рд╕рд╛рдорд╛рди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди (Marathi Inventory)
</h1>

<!-- LOGIN -->
<div id="authBox" class="card bg-white p-4 mb-4">
    <label class="font-semibold">рдлреЛрди рдирдВрдмрд░</label>
    <input id="phoneInput" class="w-full p-3 border rounded mt-1" placeholder="7020970727" />

    <div id="recaptcha-container"></div>

    <button id="sendOtpBtn" class="w-full bg-amber-600 text-white p-3 rounded mt-3">
        OTP рдкрд╛рдард╡рд╛
    </button>

    <input id="otpInput" class="w-full p-3 border rounded mt-3" placeholder="OTP рдЯрд╛рдХрд╛" />
    <button id="verifyOtpBtn" class="w-full bg-green-600 text-white p-3 rounded mt-3">
        рд▓реЙрдЧрд┐рди
    </button>
</div>

<!-- LOGGED IN -->
<div id="userBox" class="hidden card bg-white p-4 mb-4">
    <div class="flex justify-between">
        <div>
            <p id="userPhone" class="font-bold"></p>
            <p id="userRole" class="text-sm"></p>
        </div>
        <button id="logoutBtn" class="bg-gray-300 px-3 py-2 rounded">Logout</button>
    </div>
</div>

<!-- TABS -->
<div id="tabs" class="flex gap-2 mb-3 hidden">
    <button id="tabIn" class="flex-1 bg-amber-600 text-white p-3 rounded">IN</button>
    <button id="tabOut" class="flex-1 bg-white border p-3 rounded">OUT</button>
    <button id="tabRep" class="flex-1 bg-white border p-3 rounded">рд░рд┐рдкреЛрд░реНрдЯ</button>
</div>

<!-- IN PANEL -->
<div id="panelIn" class="card bg-white p-4 mb-4 hidden">
<h2 class="text-xl font-bold mb-3">IN тАФ рд╕рд╛рдорд╛рди рдШреЗрддрд▓реЗ</h2>

<form id="inForm" class="space-y-3">
    <input id="inDate" type="date" class="w-full p-3 border rounded" />
    <input id="inFrom" class="w-full p-3 border rounded" placeholder="рдХреЛрдгрд╛рдХрдбреВрди" />

    <div class="grid grid-cols-2 gap-3">
        <input id="inTotal" type="number" class="p-3 border rounded" placeholder="рдПрдХреВрдг" />
        <input id="inPaid" type="number" class="p-3 border rounded" placeholder="рднрд░рд▓реЗ" />
    </div>

    <select id="inType" class="w-full p-3 border rounded">
        <option>Cash</option>
        <option>Online</option>
        <option>Baki</option>
    </select>

    <input id="inFile" type="file" class="w-full" />

    <button class="w-full bg-amber-600 text-white p-3 rounded">рдЬрддрди рдХрд░рд╛</button>
</form>

<div id="recentIn" class="mt-3 text-sm"></div>
</div>

<!-- OUT PANEL -->
<div id="panelOut" class="card bg-white p-4 mb-4 hidden">
<h2 class="text-xl font-bold mb-3">OUT тАФ рд╕рд╛рдорд╛рди рджрд┐рд▓реЗ</h2>

<form id="outForm" class="space-y-3">
    <input id="outDate" type="date" class="w-full p-3 border rounded" />
    <input id="outTo" class="w-full p-3 border rounded" placeholder="рдХреЛрдгрд╛рд▓рд╛" />

    <div class="grid grid-cols-2 gap-3">
        <input id="outTotal" type="number" class="p-3 border rounded" placeholder="рдПрдХреВрдг" />
        <input id="outPaid" type="number" class="p-3 border rounded" placeholder="рднрд░рд▓реЗ" />
    </div>

    <select id="outType" class="w-full p-3 border rounded">
        <option>Cash</option>
        <option>Online</option>
        <option>Baki</option>
    </select>

    <input id="outFile" type="file" class="w-full" />

    <button class="w-full bg-blue-600 text-white p-3 rounded">рдЬрддрди рдХрд░рд╛</button>
</form>

<div id="recentOut" class="mt-3 text-sm"></div>
</div>

<!-- REPORT PANEL -->
<div id="panelRep" class="card bg-white p-4 mb-4 hidden">

<h2 class="text-xl font-bold mb-3">ЁЯУК рд░рд┐рдкреЛрд░реНрдЯ</h2>

<input id="filterName" class="w-full p-3 border rounded mb-2" placeholder="рдирд╛рд╡ рд╢реЛрдзрд╛" />
<input id="filterFrom" type="date" class="w-full p-3 border rounded mb-2" />
<input id="filterTo" type="date" class="w-full p-3 border rounded mb-2" />

<div id="reportStats" class="mt-3 text-sm"></div>

<div class="flex gap-2 mt-4">
    <button id="exportPdfBtn" class="flex-1 bg-gray-700 text-white p-3 rounded">PDF</button>
    <button id="exportCsvBtn" class="flex-1 bg-green-600 text-white p-3 rounded">Excel</button>
</div>

<!-- PARTтАУ5 Buttons -->
<div class="flex gap-2 mt-3">
    <button id="backupBtn" class="flex-1 bg-purple-600 text-white p-3 rounded">ЁЯУе Backup</button>
    <button id="restoreBtn" class="flex-1 bg-orange-600 text-white p-3 rounded">ЁЯУд Restore</button>
</div>

<input id="restoreFileInput" type="file" accept="application/json" class="hidden">

<!-- PARTтАУ6 Daily Summary -->
<button id="dailyPdfBtn" class="w-full bg-red-600 text-white p-3 rounded mt-3">
ЁЯУЕ Daily Summary PDF
</button>

</div>

<script>

// FIREBASE INIT
firebase.initializeApp({
  apiKey:"AIzaSyA3PdBavWlcE3w3QjgyOykv2jkAuFcUWbY",
  authDomain:"product-buy-sell.firebaseapp.com",
  projectId:"product-buy-sell",
  storageBucket:"product-buy-sell.firebasestorage.app",
  messagingSenderId:"815213852798",
  appId:"1:815213852798:web:d347aec03aa3a46ba3802f"
});

const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();


// ================= Recaptcha FIX =================
let recaptcha=null;
function setupRecaptcha(){
  if(recaptcha) return;
  recaptcha=new firebase.auth.RecaptchaVerifier("recaptcha-container",{size:"invisible"});
  recaptcha.render();
}

// ================= SEND OTP =================
document.getElementById("sendOtpBtn").onclick=async()=>{
  const mob=document.getElementById("phoneInput").value.trim();
  if(!/^[0-9]{10}$/.test(mob)) return alert("рд╡реИрдз рдирдВрдмрд░ рджреНрдпрд╛");

  setupRecaptcha();
  try{
    window.confirm=await auth.signInWithPhoneNumber("+91"+mob,recaptcha);
    alert("OTP рдкрд╛рдард╡рд▓рд╛");
  }catch(e){ alert(e.message); }
};

// ================= VERIFY OTP =================
document.getElementById("verifyOtpBtn").onclick=async()=>{
  const code=document.getElementById("otpInput").value.trim();
  try{
    await window.confirm.confirm(code);
  }catch(e){ return alert("OTP рдЪреБрдХреАрдЪрд╛"); }
};


// ================= USER STATE =================
auth.onAuthStateChanged(async(user)=>{
  const authBox=document.getElementById("authBox");
  const userBox=document.getElementById("userBox");
  const tabs=document.getElementById("tabs");

  if(!user){
    authBox.classList.remove("hidden");
    userBox.classList.add("hidden");
    tabs.classList.add("hidden");
    return;
  }

  authBox.classList.add("hidden");
  userBox.classList.remove("hidden");
  tabs.classList.remove("hidden");

  document.getElementById("userPhone").textContent=user.phoneNumber;
  document.getElementById("userRole").textContent=
    user.phoneNumber==="+917020970727"?"Admin":"User";

  loadRecent();
});

// LOGOUT
document.getElementById("logoutBtn").onclick=()=>auth.signOut();

// ================= TAB SWITCH =================
document.getElementById("tabIn").onclick=()=>showPanel("in");
document.getElementById("tabOut").onclick=()=>showPanel("out");
document.getElementById("tabRep").onclick=()=>showPanel("rep");

function showPanel(p){
  panelIn.classList.add("hidden");
  panelOut.classList.add("hidden");
  panelRep.classList.add("hidden");
  if(p==="in") panelIn.classList.remove("hidden");
  if(p==="out") panelOut.classList.remove("hidden");
  if(p==="rep") panelRep.classList.remove("hidden");
}

// ================= FILE UPLOAD =================
async function uploadFile(file,folder){
  if(!file) return null;
  const ref=storage.ref(folder+"/"+Date.now()+"_"+file.name);
  await ref.put(file);
  return await ref.getDownloadURL();
}

// ================= IN SAVE =================
inForm.onsubmit=async(e)=>{
  e.preventDefault();

  const data={
    date:inDate.value,
    from:inFrom.value,
    total:Number(inTotal.value),
    paid:Number(inPaid.value),
    balance:Number(inTotal.value)-Number(inPaid.value),
    payType:inType.value,
    createdAt:Date.now(),
    fileUrl:await uploadFile(inFile.files[0],"in")
  };

  await db.collection("in_entries").add(data);
  alert("IN рдЬрддрди рдЭрд╛рд▓реЗ");
  loadRecent();
  inForm.reset();
};

// ================= OUT SAVE =================
outForm.onsubmit=async(e)=>{
  e.preventDefault();

  const data={
    date:outDate.value,
    to:outTo.value,
    total:Number(outTotal.value),
    paid:Number(outPaid.value),
    balance:Number(outTotal.value)-Number(outPaid.value),
    payType:outType.value,
    createdAt:Date.now(),
    fileUrl:await uploadFile(outFile.files[0],"out")
  };

  await db.collection("out_entries").add(data);
  alert("OUT рдЬрддрди рдЭрд╛рд▓реЗ");
  loadRecent();
  outForm.reset();
};

// ================= LOAD RECENT =================
async function loadRecent(){
  let htmlIn="",htmlOut="";

  const inSnap=await db.collection("in_entries")
                      .orderBy("createdAt","desc").limit(5).get();

  inSnap.forEach(d=>{
    const x=d.data();
    htmlIn+=`<div class="p-2 border rounded mb-1">
    <b>${x.from}</b> тАФ тВ╣${x.total} | Paid: тВ╣${x.paid}
    </div>`;
  });

  const outSnap=await db.collection("out_entries")
                       .orderBy("createdAt","desc").limit(5).get();

  outSnap.forEach(d=>{
    const x=d.data();
    htmlOut+=`<div class="p-2 border rounded mb-1">
    <b>${x.to}</b> тАФ тВ╣${x.total} | Paid: тВ╣${x.paid}
    </div>`;
  });

  recentIn.innerHTML=htmlIn;
  recentOut.innerHTML=htmlOut;
}

// ================= REPORTS =================
filterName.oninput=loadReports;
filterFrom.onchange=loadReports;
filterTo.onchange=loadReports;

async function loadReports(){
  const name=filterName.value.trim().toLowerCase();
  const from=filterFrom.value;
  const to=filterTo.value;

  const inSnap=await db.collection("in_entries").get();
  const outSnap=await db.collection("out_entries").get();

  let IN=inSnap.docs.map(d=>d.data());
  let OUT=outSnap.docs.map(d=>d.data());

  if(name){
    IN=IN.filter(x=>x.from?.toLowerCase().includes(name));
    OUT=OUT.filter(x=>x.to?.toLowerCase().includes(name));
  }
  if(from) IN=IN.filter(x=>x.date>=from);
  if(to) IN=IN.filter(x=>x.date<=to);
  if(from) OUT=OUT.filter(x=>x.date>=from);
  if(to) OUT=OUT.filter(x=>x.date<=to);

  window._reportIn=IN;
  window._reportOut=OUT;

  const sumIn=IN.reduce((a,b)=>a+Number(b.total),0);
  const sumOut=OUT.reduce((a,b)=>a+Number(b.total),0);
  const sumPaid=[...IN,...OUT].reduce((a,b)=>a+Number(b.paid),0);
  const sumBal=[...IN,...OUT].reduce((a,b)=>a+Number(b.balance),0);

  reportStats.innerHTML=`
  <b>IN:</b> тВ╣${sumIn}<br>
  <b>OUT:</b> тВ╣${sumOut}<br>
  <b>Paid:</b> тВ╣${sumPaid}<br>
  <b>Balance:</b> тВ╣${sumBal}<br>
  `;
}

// =============== PDF EXPORT =================
document.getElementById("exportPdfBtn").onclick=()=>{
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  let y=20;

  doc.text("Inventory Report",20,y); y+=10;
  [...(window._reportIn||[]),...(window._reportOut||[])].forEach(r=>{
    doc.text(`${r.date} | тВ╣${r.total} | Paid:${r.paid}`,20,y);
    y+=10;
  });

  doc.save("Report.pdf");
};

// =============== EXCEL EXPORT =================
document.getElementById("exportCsvBtn").onclick=()=>{
  const wb=XLSX.utils.book_new();
  const rows=[["Type","Date","Name","Total","Paid","Balance"]];

  (window._reportIn||[]).forEach(r=>{
    rows.push(["IN",r.date,r.from,r.total,r.paid,r.balance]);
  });
  (window._reportOut||[]).forEach(r=>{
    rows.push(["OUT",r.date,r.to,r.total,r.paid,r.balance]);
  });

  const sh=XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,sh,"Report");
  XLSX.writeFile(wb,"Report.xlsx");
};

// =============== BACKUP (JSON) =================
backupBtn.onclick=async()=>{
  const IN=(await db.collection("in_entries").get()).docs.map(d=>d.data());
  const OUT=(await db.collection("out_entries").get()).docs.map(d=>d.data());

  const obj={date:new Date(),IN,OUT};
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);

  const a=document.createElement("a");
  a.href=url;
  a.download="Backup.json";
  a.click();
};

// =============== RESTORE =================
restoreBtn.onclick=()=>restoreFileInput.click();

restoreFileInput.onchange=async(e)=>{
  const file=e.target.files[0];
  if(!file) return;

  const text=await file.text();
  const json=JSON.parse(text);

  json.IN.forEach(x=>db.collection("in_entries").add(x));
  json.OUT.forEach(x=>db.collection("out_entries").add(x));

  alert("Restore Completed");
  loadRecent();
};

// =============== DAILY SUMMARY PDF =================
dailyPdfBtn.onclick=async()=>{
  const today=new Date().toISOString().slice(0,10);

  const inSnap=await db.collection("in_entries").where("date","==",today).get();
  const outSnap=await db.collection("out_entries").where("date","==",today).get();

  const IN=inSnap.docs.map(d=>d.data());
  const OUT=outSnap.docs.map(d=>d.data());

  if(IN.length===0 && OUT.length===0) return alert("рдЖрдЬ рдХрд╛рд╣реА рдПрдВрдЯреНрд░реА рдирд╛рд╣реА");

  const sumIn=IN.reduce((a,b)=>a+Number(b.total),0);
  const sumOut=OUT.reduce((a,b)=>a+Number(b.total),0);

  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();

  doc.text(`Daily Summary - ${today}`,20,20);
  doc.text(`IN: тВ╣${sumIn}`,20,40);
  doc.text(`OUT: тВ╣${sumOut}`,20,55);

  doc.save("DailySummary.pdf");
};

</script>

</body>
</html>
