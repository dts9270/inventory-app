<!doctype html>
<html lang="mr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ЁЯУж рд╕рд╛рдорд╛рди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди (Marathi Inventory тАУ No OTP)</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- SheetJS Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Inter, system-ui; background:#FFF7ED; }
.card { border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
.small-muted { font-size:0.85rem; color:#666; }
</style>
</head>

<body class="p-4">
<div class="max-w-lg mx-auto">
<h1 class="text-2xl font-bold text-amber-700 text-center mb-4">ЁЯУж рд╕рд╛рдорд╛рди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди</h1>

<!-- TABS -->
<div class="flex gap-2 mb-4">
<button id="tabIn" class="flex-1 bg-amber-600 text-white p-3 rounded">IN (рдШреЗрдгреЗ)</button>
<button id="tabOut" class="flex-1 bg-white border p-3 rounded">OUT (рджреЗрдгреЗ)</button>
<button id="tabRep" class="flex-1 bg-white border p-3 rounded">рд░рд┐рдкреЛрд░реНрдЯ</button>
</div>

<!-- IN PANEL -->
<div id="panelIn" class="card bg-white p-4 mb-4">
<h2 class="font-bold text-lg mb-2">IN тАФ рд╕рд╛рдорд╛рди рдШреЗрддрд▓реЗ</h2>

<form id="inForm" class="space-y-3">
  <label class="small-muted">рддрд╛рд░реАрдЦ</label>
  <input id="inDate" type="date" class="w-full p-3 border rounded"/>

  <label class="small-muted">рдХреЛрдгрд╛рдХрдбреВрди</label>
  <input id="inFrom" class="w-full p-3 border rounded" placeholder="рдкреБрд░рд╡рдард╛рджрд╛рд░рд╛рдЪреЗ рдирд╛рд╡"/>

  <div class="grid grid-cols-2 gap-3">
    <div>
      <label class="small-muted">рдПрдХреВрдг рд░рдХреНрдХрдо (тВ╣)</label>
      <input id="inTotal" type="number" class="w-full p-3 border rounded"/>
    </div>
    <div>
      <label class="small-muted">рднрд░рд▓реЗ (Paid тВ╣)</label>
      <input id="inPaid" type="number" class="w-full p-3 border rounded"/>
    </div>
  </div>

  <label class="small-muted">рдкреЗрдореЗрдВрдЯ рдкреНрд░рдХрд╛рд░</label>
  <select id="inPayType" class="w-full p-3 border rounded">
    <option>Cash</option><option>Online</option><option>Baki</option>
  </select>

  <label class="small-muted">рдмрд┐рд▓ / рдлреЛрдЯреЛ (рдРрдЪреНрдЫрд┐рдХ)</label>
  <input id="inFile" type="file" accept="image/*,application/pdf" class="w-full"/>

  <div class="flex gap-2">
    <button class="flex-1 bg-amber-600 text-white p-3 rounded" type="submit">IN рдЬрддрди рдХрд░рд╛</button>
    <button id="inClear" type="button" class="flex-1 bg-gray-300 p-3 rounded">Clear</button>
  </div>
</form>

<h3 class="mt-4 font-semibold">рддрд╛рдЬреНрдпрд╛ IN рдиреЛрдВрджреА</h3>
<div id="recentIn" class="mt-2 text-sm"></div>
</div>

<!-- OUT PANEL -->
<div id="panelOut" class="card bg-white p-4 mb-4 hidden">
<h2 class="font-bold text-lg mb-2">OUT тАФ рд╕рд╛рдорд╛рди рджрд┐рд▓реЗ</h2>

<form id="outForm" class="space-y-3">
  <label class="small-muted">рддрд╛рд░реАрдЦ</label>
  <input id="outDate" type="date" class="w-full p-3 border rounded"/>

  <label class="small-muted">рдХреЛрдгрд╛рд▓рд╛</label>
  <input id="outTo" class="w-full p-3 border rounded" placeholder="рдЧреНрд░рд╛рд╣рдХрд╛рдЪреЗ рдирд╛рд╡"/>

  <div class="grid grid-cols-2 gap-3">
    <div>
      <label class="small-muted">рдПрдХреВрдг рд░рдХреНрдХрдо (тВ╣)</label>
      <input id="outTotal" type="number" class="w-full p-3 border rounded"/>
    </div>
    <div>
      <label class="small-muted">рднрд░рд▓реЗ (Paid тВ╣)</label>
      <input id="outPaid" type="number" class="w-full p-3 border rounded"/>
    </div>
  </div>

  <label class="small-muted">рдкреЗрдореЗрдВрдЯ рдкреНрд░рдХрд╛рд░</label>
  <select id="outPayType" class="w-full p-3 border rounded">
    <option>Cash</option><option>Online</option><option>Baki</option>
  </select>

  <label class="small-muted">рдмрд┐рд▓ / рдлреЛрдЯреЛ (рдРрдЪреНрдЫрд┐рдХ)</label>
  <input id="outFile" type="file" accept="image/*,application/pdf" class="w-full"/>

  <div class="flex gap-2">
    <button class="flex-1 bg-blue-600 text-white p-3 rounded" type="submit">OUT рдЬрддрди рдХрд░рд╛</button>
    <button id="outClear" type="button" class="flex-1 bg-gray-300 p-3 rounded">Clear</button>
  </div>
</form>

<h3 class="mt-4 font-semibold">рддрд╛рдЬреНрдпрд╛ OUT рдиреЛрдВрджреА</h3>
<div id="recentOut" class="mt-2 text-sm"></div>
</div>

<!-- REPORT PANEL -->
<div id="panelRep" class="card bg-white p-4 mb-4 hidden">
<h2 class="font-bold text-lg mb-3">рд░рд┐рдкреЛрд░реНрдЯ</h2>

<input id="filterName" class="w-full p-3 border rounded mb-2" placeholder="рдирд╛рд╡ рд╢реЛрдзрд╛"/>

<div class="grid grid-cols-2 gap-2 mb-3">
  <input id="filterFrom" type="date" class="p-3 border rounded"/>
  <input id="filterTo" type="date" class="p-3 border rounded"/>
</div>

<div id="reportStats" class="text-sm mb-3"></div>

<div class="flex gap-2">
  <button id="exportPdfBtn" class="flex-1 bg-gray-700 text-white p-3 rounded">PDF</button>
  <button id="exportExcelBtn" class="flex-1 bg-green-600 text-white p-3 rounded">Excel</button>
</div>

<div class="flex gap-2 mt-3">
  <button id="backupBtn" class="flex-1 bg-purple-600 text-white p-3 rounded">ЁЯУе рдмреЕрдХрдЕрдк</button>
  <button id="restoreBtn" class="flex-1 bg-orange-600 text-white p-3 rounded">ЁЯУд Restore</button>
</div>

<input id="restoreFileInput" type="file" accept="application/json" class="hidden"/>

<button id="dailyPdfBtn" class="w-full bg-red-600 text-white p-3 rounded mt-3">ЁЯУЕ Daily PDF</button>
</div>

<script>
// ---------------------- Firebase Init --------------------------
const firebaseConfig = {
  apiKey: "AIzaSyA3PdBavWlcE3w3QjgyOykv2jkAuFcUWbY",
  authDomain: "product-buy-sell.firebaseapp.com",
  projectId: "product-buy-sell",
  storageBucket: "product-buy-sell.firebasestorage.app",
  messagingSenderId: "815213852798",
  appId: "1:815213852798:web:d347aec03aa3a46ba3802f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// ---------------------- UI Panel Switch ------------------------
function showPanel(n) {
  panelIn.classList.add("hidden");
  panelOut.classList.add("hidden");
  panelRep.classList.add("hidden");
  if (n === "in") panelIn.classList.remove("hidden");
  if (n === "out") panelOut.classList.remove("hidden");
  if (n === "rep") panelRep.classList.remove("hidden");
}
tabIn.onclick = () => showPanel("in");
tabOut.onclick = () => showPanel("out");
tabRep.onclick = () => showPanel("rep");

// default
showPanel("in");

// ---------------------- File Upload ----------------------------
async function uploadFile(file, folder) {
  if (!file) return null;
  const path = `${folder}/${Date.now()}_${file.name}`;
  const ref = storage.ref().child(path);
  await ref.put(file);
  return await ref.getDownloadURL();
}

// ---------------------- IN SAVE ----------------------------
inForm.onsubmit = async (e) => {
  e.preventDefault();
  try {
    const fURL = await uploadFile(inFile.files[0], "in");
    await db.collection("in_entries").add({
      date: inDate.value,
      from: inFrom.value,
      total: Number(inTotal.value),
      paid: Number(inPaid.value),
      balance: Number(inTotal.value) - Number(inPaid.value),
      payType: inPayType.value,
      fileURL: fURL,
      createdAt: Date.now()
    });
    inForm.reset();
    loadRecent();
  } catch (err) { alert("IN Error: " + err.message); }
};

// ---------------------- OUT SAVE ----------------------------
outForm.onsubmit = async (e) => {
  e.preventDefault();
  try {
    const fURL = await uploadFile(outFile.files[0], "out");
    await db.collection("out_entries").add({
      date: outDate.value,
      to: outTo.value,
      total: Number(outTotal.value),
      paid: Number(outPaid.value),
      balance: Number(outTotal.value) - Number(outPaid.value),
      payType: outPayType.value,
      fileURL: fURL,
      createdAt: Date.now()
    });
    outForm.reset();
    loadRecent();
  } catch (err) { alert("OUT Error: " + err.message); }
};

// ---------------------- Recent Loads -------------------------
async function loadRecent() {
  const inSnap = await db.collection("in_entries").orderBy("createdAt","desc").limit(10).get();
  recentIn.innerHTML = "";
  inSnap.forEach(d => {
    const v = d.data();
    recentIn.innerHTML += `<div class="p-2 border rounded mb-1">IN: тВ╣${v.total} | Paid тВ╣${v.paid} | Bal тВ╣${v.balance}</div>`;
  });

  const outSnap = await db.collection("out_entries").orderBy("createdAt","desc").limit(10).get();
  recentOut.innerHTML = "";
  outSnap.forEach(d => {
    const v = d.data();
    recentOut.innerHTML += `<div class="p-2 border rounded mb-1">OUT: тВ╣${v.total} | Paid тВ╣${v.paid} | Bal тВ╣${v.balance}</div>`;
  });
}
loadRecent();

// ---------------------- REPORT LOAD -------------------------
async function loadReport() {
  const fName = filterName.value.toLowerCase();
  const fF = filterFrom.value ? new Date(filterFrom.value) : null;
  const fT = filterTo.value ? new Date(filterTo.value) : null;

  const inSnap = await db.collection("in_entries").orderBy("date","desc").get();
  const outSnap = await db.collection("out_entries").orderBy("date","desc").get();

  const IN = inSnap.docs.map(d => d.data());
  const OUT = outSnap.docs.map(d => d.data());

  let fin = IN.filter(x =>
    (!fName || (x.from||"").toLowerCase().includes(fName)) &&
    (!fF || new Date(x.date)>=fF) &&
    (!fT || new Date(x.date)<=fT)
  );

  let fout = OUT.filter(x =>
    (!fName || (x.to||"").toLowerCase().includes(fName)) &&
    (!fF || new Date(x.date)>=fF) &&
    (!fT || new Date(x.date)<=fT)
  );

  // totals
  let inTot = fin.reduce((a,b)=>a+(b.total||0),0);
  let inPaid = fin.reduce((a,b)=>a+(b.paid||0),0);
  let outTot = fout.reduce((a,b)=>a+(b.total||0),0);
  let outPaid = fout.reduce((a,b)=>a+(b.paid||0),0);

  reportStats.innerHTML =
    `<div class="p-2 border rounded">
      <div>IN Total тВ╣${inTot} | Paid тВ╣${inPaid} | Bal тВ╣${inTot-inPaid}</div>
      <div>OUT Total тВ╣${outTot} | Paid тВ╣${outPaid} | Bal тВ╣${outTot-outPaid}</div>
    </div>`;

  window._reportIN = fin;
  window._reportOUT = fout;
}

// update on filters
filterName.oninput = filterFrom.onchange = filterTo.onchange = () => loadReport();

// ---------------------- PDF Export -------------------------
exportPdfBtn.onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("Inventory Report", 10, 10);
  let y = 20;

  (_reportIN||[]).forEach(r=>{
    doc.text(`IN | ${r.date} | ${r.from} | Total тВ╣${r.total} | Paid тВ╣${r.paid}`,10,y);
    y += 8; if(y>270){ doc.addPage(); y=20; }
  });

  doc.addPage();
  y=20;
  (_reportOUT||[]).forEach(r=>{
    doc.text(`OUT | ${r.date} | ${r.to} | Total тВ╣${r.total} | Paid тВ╣${r.paid}`,10,y);
    y += 8; if(y>270){ doc.addPage(); y=20; }
  });

  doc.save("report.pdf");
};

// ---------------------- Excel Export -------------------------
exportExcelBtn.onclick = () => {
  const wb = XLSX.utils.book_new();
  const rows = [
    ["Type","Date","Name","Total","Paid","Balance","PayType","FileURL"]
  ];

  (_reportIN||[]).forEach(r=>rows.push(["IN",r.date,r.from,r.total,r.paid,r.balance,r.payType,r.fileURL||""]));
  (_reportOUT||[]).forEach(r=>rows.push(["OUT",r.date,r.to,r.total,r.paid,r.balance,r.payType,r.fileURL||""]));

  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,"Report");
  XLSX.writeFile(wb,"report.xlsx");
};

// ---------------------- BACKUP -------------------------
backupBtn.onclick = async () => {
  const all = {};

  const inSnap = await db.collection("in_entries").get();
  const outSnap = await db.collection("out_entries").get();

  all.in = inSnap.docs.map(d=>d.data());
  all.out = outSnap.docs.map(d=>d.data());

  const blob = new Blob([JSON.stringify(all)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "backup.json";
  a.click();
};

// ---------------------- RESTORE -------------------------
restoreBtn.onclick = () => restoreFileInput.click();

restoreFileInput.onchange = async (e) =>{
  try{
    const file = e.target.files[0];
    const txt = await file.text();
    const data = JSON.parse(txt);

    if(data.in) data.in.forEach(v=>db.collection("in_entries").add(v));
    if(data.out) data.out.forEach(v=>db.collection("out_entries").add(v));
    alert("Restore рдкреВрд░реНрдг");
  }catch(err){ alert("Restore Error: "+err.message); }
};

// ---------------------- DAILY PDF -------------------------
dailyPdfBtn.onclick = async () => {
  const today = new Date().toISOString().slice(0,10);
  filterFrom.value = today;
  filterTo.value = today;
  await loadReport();

  exportPdfBtn.click();
};

</script>
</body>
</html>
