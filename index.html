<!doctype html>
<html lang="mr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>рд╕рд╛рдорд╛рди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди тАУ Inventory App</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    body { font-family: sans-serif; }
    .card { border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    .big { font-size: 1.1rem; font-weight: 600; }
    .small { font-size: .9rem; }
    button { touch-action: manipulation; }
  </style>
</head>

<body class="bg-amber-50 p-4">
  <div class="max-w-xl mx-auto">
    <h1 class="text-2xl font-bold text-amber-700 text-center mb-4">ЁЯУж рд╕рд╛рдорд╛рди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди</h1>

    <!-- AUTH -->
    <div id="authBox" class="card bg-white p-4 mb-4">
      <label class="big">рдлреЛрди рдирдВрдмрд░</label>
      <div class="flex gap-2 mt-2">
        <input id="phone" class="flex-1 p-3 border rounded text-lg" placeholder="7020970727" />
        <button id="sendOtp" class="px-4 py-3 bg-amber-600 text-white rounded big">OTP</button>
      </div>

      <div id="recaptcha-container" class="mt-2"></div>

      <div id="otpArea" class="hidden mt-3 flex gap-2">
        <input id="otp" class="flex-1 p-3 border rounded text-lg" placeholder="OTP" />
        <button id="verifyOtp" class="px-4 py-3 bg-green-600 text-white rounded">OK</button>
      </div>

      <div id="userBox" class="hidden mt-2">
        <div id="userPhone" class="font-bold"></div>
        <div id="roleText" class="text-sm text-gray-600"></div>
        <button id="logout" class="mt-2 px-3 py-2 bg-gray-200 rounded">Logout</button>
      </div>
    </div>
    <!-- TABS -->
    <div class="flex gap-2 mb-3">
      <button id="tabIn" class="flex-1 py-3 bg-amber-600 text-white rounded big">ЁЯУе IN</button>
      <button id="tabOut" class="flex-1 py-3 bg-white rounded big">ЁЯУд OUT</button>
      <button id="tabReport" class="flex-1 py-3 bg-white rounded big">ЁЯУК рд░рд┐рдкреЛрд░реНрдЯ</button>
    </div>

    <!-- IN PANEL -->
    <div id="panelIn" class="card bg-white p-4 mb-4">
      <h2 class="font-bold big mb-2">IN тАФ рд╕рд╛рдорд╛рди рдШреЗрддрд▓реЗ</h2>

      <label class="small">рддрд╛рд░реАрдЦ</label>
      <input id="inDate" type="date" class="w-full p-3 border rounded mb-2">

      <label class="small">рдХреЛрдгрд╛рдХрдбреВрди</label>
      <input id="inFrom" class="w-full p-3 border rounded mb-2" placeholder="рдирд╛рд╡">

      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="small">рдПрдХреВрдг (тВ╣)</label>
          <input id="inTotal" class="w-full p-3 border rounded mb-2">
        </div>
        <div>
          <label class="small">рднрд░рд▓реЗ (тВ╣)</label>
          <input id="inPaid" class="w-full p-3 border rounded mb-2">
        </div>
      </div>

      <label class="small">рдкреЗрдореЗрдВрдЯ рдкреНрд░рдХрд╛рд░</label>
      <select id="inType" class="w-full p-3 border rounded mb-3">
        <option>Cash</option>
        <option>Online</option>
        <option>Baki</option>
      </select>

      <label class="small">рдмрд┐рд▓ / рдлреЛрдЯреЛ</label>
      <input id="inFile" type="file" class="w-full mb-3">

      <button id="saveIn" class="w-full py-3 bg-amber-600 text-white rounded big mb-2">рдЬрддрди рдХрд░рд╛</button>

      <div id="recentIn" class="text-sm text-gray-700"></div>
    </div>

    <!-- OUT PANEL -->
    <div id="panelOut" class="card bg-white p-4 mb-4 hidden">
      <h2 class="font-bold big mb-2">OUT тАФ рд╕рд╛рдорд╛рди рджрд┐рд▓реЗ</h2>

      <label class="small">рддрд╛рд░реАрдЦ</label>
      <input id="outDate" type="date" class="w-full p-3 border rounded mb-2">

      <label class="small">рдХреЛрдгрд╛рд▓рд╛</label>
      <input id="outTo" class="w-full p-3 border rounded mb-2" placeholder="рдЧреНрд░рд╛рд╣рдХрд╛рдЪреЗ рдирд╛рд╡">

      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="small">рдПрдХреВрдг (тВ╣)</label>
          <input id="outTotal" class="w-full p-3 border rounded mb-2">
        </div>
        <div>
          <label class="small">рднрд░рд▓реЗ (тВ╣)</label>
          <input id="outPaid" class="w-full p-3 border rounded mb-2">
        </div>
      </div>

      <label class="small">рдкреЗрдореЗрдВрдЯ рдкреНрд░рдХрд╛рд░</label>
      <select id="outType" class="w-full p-3 border rounded mb-3">
        <option>Cash</option>
        <option>Online</option>
        <option>Baki</option>
      </select>

      <label class="small">рдкреНрд░реВрдл / рдлреЛрдЯреЛ</label>
      <input id="outFile" type="file" class="w-full mb-3">

      <button id="saveOut" class="w-full py-3 bg-blue-600 text-white rounded big mb-2">рдЬрддрди рдХрд░рд╛</button>

      <div id="recentOut" class="text-sm text-gray-700"></div>
    </div>

    <!-- REPORT PANEL -->
    <div id="panelReport" class="card bg-white p-4 mb-4 hidden">
      <h2 class="font-bold big mb-2">ЁЯУК рд░рд┐рдкреЛрд░реНрдЯ</h2>

      <label class="small">рдирд╛рд╡рд╛рд╡рд░ рд╢реЛрдзрд╛</label>
      <input id="searchName" class="w-full p-3 border rounded mb-2" placeholder="рдирд╛рд╡">

      <label class="small">рддрд╛рд░реАрдЦ рдкрд╛рд╕реВрди</label>
      <input id="fromDate" type="date" class="w-full p-3 border rounded mb-2">

      <label class="small">рддрд╛рд░реАрдЦ рдкрд░реНрдпрдВрдд</label>
      <input id="toDate" type="date" class="w-full p-3 border rounded mb-2">

      <button id="loadReport" class="w-full py-3 bg-green-600 text-white rounded big mb-3">рд░рд┐рдкреЛрд░реНрдЯ рдкрд╛рд╣рд╛</button>

      <div id="reportData" class="text-sm"></div>
  </div>
  <script>
/* ------------------------------------------
   Firebase Setup
-------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyA3PdBavWlcE3w3QjgyOykv2jkAuFcUWbY",
  authDomain: "product-buy-sell.firebaseapp.com",
  projectId: "product-buy-sell",
  storageBucket: "product-buy-sell.firebasestorage.app",
  messagingSenderId: "815213852798",
  appId: "1:815213852798:web:d347aec03aa3a46ba3802f"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ------------------------------------------
   Short Functions
-------------------------------------------- */
function show(id){ document.getElementById(id).classList.remove("hidden"); }
function hide(id){ document.getElementById(id).classList.add("hidden"); }
function msg(t){ alert(t); }

/* ------------------------------------------
   TABS
-------------------------------------------- */
const panelIn = document.getElementById("panelIn");
const panelOut = document.getElementById("panelOut");
const panelReport = document.getElementById("panelReport");

document.getElementById("tabIn").onclick = ()=>{
  show("panelIn"); hide("panelOut"); hide("panelReport");
  document.getElementById("tabIn").className="flex-1 py-3 bg-amber-600 text-white rounded big";
  document.getElementById("tabOut").className="flex-1 py-3 bg-white rounded big";
  document.getElementById("tabReport").className="flex-1 py-3 bg-white rounded big";
};

document.getElementById("tabOut").onclick = ()=>{
  show("panelOut"); hide("panelIn"); hide("panelReport");
  document.getElementById("tabOut").className="flex-1 py-3 bg-blue-600 text-white rounded big";
  document.getElementById("tabIn").className="flex-1 py-3 bg-white rounded big";
  document.getElementById("tabReport").className="flex-1 py-3 bg-white rounded big";
};

document.getElementById("tabReport").onclick = ()=>{
  show("panelReport"); hide("panelIn"); hide("panelOut");
  document.getElementById("tabReport").className="flex-1 py-3 bg-green-600 text-white rounded big";
  document.getElementById("tabIn").className="flex-1 py-3 bg-white rounded big";
  document.getElementById("tabOut").className="flex-1 py-3 bg-white rounded big";
};

/* ------------------------------------------
   ENABLE / DISABLE FORM (Fix version)
-------------------------------------------- */
function enableForms(v){
  document.querySelectorAll("input,select,button").forEach(el=>{
    // Phone + OTP always editable
    if(["phone","otp","sendOtp","verifyOtp"].includes(el.id)) return;
    el.disabled = !v;
  });
}

/* ------------------------------------------
   OTP LOGIN
-------------------------------------------- */
let confirmation;

document.getElementById("sendOtp").onclick = async ()=>{
  const mobile = document.getElementById("phone").value.trim();
  if(!/^[0-9]{10}$/.test(mobile)) return msg("рдпреЛрдЧреНрдп 10 рдЕрдВрдХреА рдирдВрдмрд░ рджреНрдпрд╛");

  // Start invisible recaptcha
  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
    'recaptcha-container', { size: 'invisible' }
  );

  try{
    confirmation = await auth.signInWithPhoneNumber("+91"+mobile, window.recaptchaVerifier);
    show("otpArea");
    msg("OTP рдкрд╛рдард╡рд▓реЗ рдЖрд╣реЗ");
  }catch(e){
    console.log(e);
    msg("OTP Error: " + e.message);
  }
};

document.getElementById("verifyOtp").onclick = async ()=>{
  const code = document.getElementById("otp").value.trim();
  if(!code) return msg("OTP рдЯрд╛рдХрд╛");

  try{
    const result = await confirmation.confirm(code);
    const user = result.user;
    onLogin(user);
  }catch(e){
    console.log(e);
    msg("OTP рдЪреБрдХреАрдЪрд╛ рдЖрд╣реЗ");
  }
};

/* ------------------------------------------
   LOGIN SUCCESS
-------------------------------------------- */
function onLogin(user){
  hide("otpArea");
  document.getElementById("userBox").classList.remove("hidden");
  document.getElementById("userPhone").innerText = user.phoneNumber;

  const isAdmin = user.phoneNumber === "+917020970727"; // admin number
  document.getElementById("roleText").innerText = isAdmin ? "Admin рдкреНрд░рд╡реЗрд╢" : "User рдкреНрд░рд╡реЗрд╢";

  enableForms(true);
  loadRecentIn();
  loadRecentOut();
}

document.getElementById("logout").onclick = ()=>{
  auth.signOut();
  location.reload();
};

/* ------------------------------------------
   FILE UPLOAD HELPER
-------------------------------------------- */
async function uploadFile(f, folder){
  if(!f) return null;
  const ref = storage.ref().child(folder + "/" + Date.now() + "_" + f.name);
  const snap = await ref.put(f);
  return await snap.ref.getDownloadURL();
}

/* ------------------------------------------
   SAVE IN
-------------------------------------------- */
document.getElementById("saveIn").onclick = async ()=>{

  const date = document.getElementById("inDate").value;
  const from = document.getElementById("inFrom").value.trim();
  const total = Number(document.getElementById("inTotal").value);
  const paid = Number(document.getElementById("inPaid").value);
  const type = document.getElementById("inType").value;
  const file = document.getElementById("inFile").files[0];

  if(!from || total<=0) return msg("рдкреВрд░реНрдг рдорд╛рд╣рд┐рддреА рднрд░рд╛");

  const url = await uploadFile(file,"in");

  await db.collection("in_entries").add({
    date, from, total, paid,
    balance: total-paid,
    paymentType: type,
    fileUrl: url || null,
    created: Date.now()
  });

  msg("IN рдЬрддрди рдЭрд╛рд▓реЗ");
  loadRecentIn();
};

/* LOAD Recent IN */
async function loadRecentIn(){
  const box = document.getElementById("recentIn");
  box.innerHTML = "рд▓реЛрдб рд╣реЛрдд рдЖрд╣реЗтАж";

  const snap = await db.collection("in_entries")
    .orderBy("created","desc")
    .limit(10).get();

  box.innerHTML = "";
  snap.forEach(d=>{
    const x = d.data();
    box.innerHTML += `
      <div class="p-2 border rounded mb-1">
        <b>${x.from}</b> тАФ ${x.date}<br>
        Total тВ╣${x.total} | Paid тВ╣${x.paid} | Bal тВ╣${x.balance}<br>
        ${x.fileUrl ? `<a href="${x.fileUrl}" target="_blank" class="text-blue-600 text-xs">рдмрд┐рд▓ рдкрд╣рд╛</a>` : ""}
      </div>`;
  });
}

/* ------------------------------------------
   SAVE OUT
-------------------------------------------- */
document.getElementById("saveOut").onclick = async ()=>{

  const date = document.getElementById("outDate").value;
  const to = document.getElementById("outTo").value.trim();
  const total = Number(document.getElementById("outTotal").value);
  const paid = Number(document.getElementById("outPaid").value);
  const type = document.getElementById("outType").value;
  const file = document.getElementById("outFile").files[0];

  if(!to || total<=0) return msg("рдкреВрд░реНрдг рдорд╛рд╣рд┐рддреА рднрд░рд╛");

  const url = await uploadFile(file,"out");

  await db.collection("out_entries").add({
    date, to, total, paid,
    balance: total-paid,
    paymentType: type,
    fileUrl: url || null,
    created: Date.now()
  });

  msg("OUT рдЬрддрди рдЭрд╛рд▓реЗ");
  loadRecentOut();
};

/* LOAD Recent OUT */
async function loadRecentOut(){
  const box = document.getElementById("recentOut");
  box.innerHTML = "рд▓реЛрдб рд╣реЛрдд рдЖрд╣реЗтАж";

  const snap = await db.collection("out_entries")
    .orderBy("created","desc")
    .limit(10).get();

  box.innerHTML = "";
  snap.forEach(d=>{
    const x = d.data();
    box.innerHTML += `
      <div class="p-2 border rounded mb-1">
        <b>${x.to}</b> тАФ ${x.date}<br>
        Total тВ╣${x.total} | Paid тВ╣${x.paid} | Bal тВ╣${x.balance}<br>
        ${x.fileUrl ? `<a href="${x.fileUrl}" target="_blank" class="text-blue-600 text-xs">рдкреНрд░реВрдл</a>` : ""}
      </div>`;
  });
}

/* ------------------------------------------
   REPORT SECTION
-------------------------------------------- */
document.getElementById("loadReport").onclick = async ()=>{

  const name = document.getElementById("searchName").value.trim().toLowerCase();
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;

  const reportBox = document.getElementById("reportData");
  reportBox.innerHTML = "рд▓реЛрдб рд╣реЛрдд рдЖрд╣реЗтАж";

  const IN = await db.collection("in_entries").get();
  const OUT = await db.collection("out_entries").get();

  let list = [];

  IN.forEach(d=>{
    const x = d.data();
    list.push({
      type:"IN",
      name:x.from,
      date:x.date,
      total:x.total,
      paid:x.paid,
      bal:x.balance
    });
  });

  OUT.forEach(d=>{
    const x = d.data();
    list.push({
      type:"OUT",
      name:x.to,
      date:x.date,
      total:x.total,
      paid:x.paid,
      bal:x.balance
    });
  });

  // FILTER
  list = list.filter(x=>{
    if(name && !x.name.toLowerCase().includes(name)) return false;
    if(from && x.date < from) return false;
    if(to && x.date > to) return false;
    return true;
  });

  // SHOW
  reportBox.innerHTML = "";
  list.forEach(x=>{
    reportBox.innerHTML += `
      <div class="p-2 border rounded mb-1">
        <b>${x.type}</b> тАФ ${x.name}<br>
        ${x.date} | Total тВ╣${x.total} | Paid тВ╣${x.paid} | Bal тВ╣${x.bal}
      </div>`;
  });

  if(!list.length) reportBox.innerHTML = "рдХрд╛рд╣реА рдиреЛрдВрджреА рдирд╛рд╣реАрдд";
};

</script>

</body>
</html>
